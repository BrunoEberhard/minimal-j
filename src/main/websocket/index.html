<html>
<head>
<title>Build page</title>

<script src="dialog-polyfill.js"></script>
<link rel="stylesheet" type="text/css" href="dialog-polyfill.css" />
 
<link rel="stylesheet" type="text/css" href="mj.css" />
<script type="text/javascript">
	"use strict";
	var websocket;
	var session;
	
	function onMessage(evt) {
        var dataObject = JSON.parse(evt.data);
        session = dataObject["session"];
        if (dataObject["content"] != undefined) {
        	showContent(dataObject["content"]);
        }
        if (dataObject["menu"] != undefined) {
        	showMenuBar(dataObject["menu"]);
        }
        var pageId = dataObject["pageId"];
        if (pageId != undefined) {
        	if (history.state != pageId) {
	        	history.pushState(dataObject["pageId"]);
        	}
        }         
        if (dataObject["dialog"] != undefined) {
        	showDialog(dataObject["dialog"]);
        }
        if (dataObject["closeDialog"] != undefined) {
        	document.getElementById(dataObject["closeDialog"]).close();
        }     
        if (dataObject["propertyChanges"] != undefined) {
        	var propertyChanges = dataObject["propertyChanges"];
        	for (var i = 0; i<propertyChanges.length; i++) {
        		var propertyChange = propertyChanges[i];
        		var id = propertyChange.id;
        		var property = propertyChange.property;
        		var value = propertyChange.value;
        		var element = document.getElementById(id);
        		if (element != undefined) {
        			if (property == "tableContent") {
        				document.getElementById(id).appendChild(createTableRows(id, value));
        			} else if (property == "validationMessage") {
        				element = document.getElementById(id + "-validation");
        				if (value == undefined || value == "") {
        					element.className = "hide";
        				} else {
        					element.className = "";
        					element.title = value;
        				}
        			} else {
                		document.getElementById(id)[property] = value;
        			}
        		}
        	}
        }
	}
	function onError(evt) {
	}
       
	function showContent(content) {
		var contentElement = document.getElementById("content");
		while (contentElement.firstChild) {
			contentElement.removeChild(contentElement.firstChild);
		}
		
       	var element = createContent(content);
       	if (content.type == "Form") {
       		var p = document.createElement("table");
       		p.className = "formContainer";
       		
       		var paddingLeft = document.createElement("td");
			paddingLeft.className = "nopadding";
			paddingLeft.width = "10%";
			p.appendChild(paddingLeft);
			
			var formContent = document.createElement("td");
			p.appendChild(element);
			
       		var paddingRight = document.createElement("td");
       		paddingRight.className = "nopadding";
       		paddingRight.width = "20%";
       		p.appendChild(paddingRight);
       		
       		contentElement.appendChild(p);
       	} else {
       		contentElement.appendChild(element);
       	}
    }	
       
    function createContent(content) {
       	var type = content.type;
       	var element;
       	if (type == "Form") {
       		element = document.createElement("table");
       		element.className = "form";
       		element.columns = content.columns;
       		element.setAttribute("width", (content.columns * content.columnWidth / 4) + "ex"); 
       		var rows = content.rows;
       		element.appendChild(createFormRows(rows));
       	} else if (type == "Table") {
       		element = document.createElement("table");
       		element.appendChild(createTableHeaders(content.headers));
       	} else if (type == "ReadOnlyTextField") {
       		element = document.createElement("div");
       		if (content.value != undefined) {
	       		element.appendChild(document.createTextNode(content.value));
       		} else {
	       		element.innerHTML = "&nbsp;";
       		}
       	} else if (type == "Label") {
       		element = document.createElement("div");
       		if (content.value != undefined) {
	       		element.innerHTML = content.value;
       		} else {
	       		element.innerHTML = "&nbsp;";
       		}
       	} else if (type == "Group") {
       		element = document.createElement("table");
       		element.className = "group";
       		var tr = document.createElement("tr");
       		element.appendChild(tr);
       		var components = content.components;
       		for (var i = 0; i<components.length; i++) {
       			var td = document.createElement("td");
       			td.appendChild(createContent(components[i]));
       			tr.appendChild(td);
       		}
       	} else if (type == "Action") {
       		element = document.createElement("div");
       		element.className = "action";
       		element.innerHTML = content.name;
       		element.setAttribute("onclick", "action(\"" + content.id + "\");");
       	} else if (type == "TextField") {
       		element = document.createElement("input");
       		element.type="text";
       		element.setAttribute("onchange", "sendchange(this);");
       		if (content.value != undefined) {
	       		element.appendChild(document.createTextNode(content.value));
       		}
       	} else if (type == "Combobox") {
       		element = document.createElement("select");
       		var option = document.createElement("option");
       		element.appendChild(option);
       		if (content.options != undefined) {
       			for (var id in content.options) {
       				var option = document.createElement("option");
       				option.value = id;
       				option.innerHTML = content.options[id];
		       		element.appendChild(option);
       			}
       		}       
       		element.value = content.value;
       		element.setAttribute("onchange", "sendchange(this);");
       	} else if (type == "Vertical") {
       		element = document.createElement("div");
       		var components = content.components;
       		for (var i = 0; i<components.length; i++) {
       			element.appendChild(createContent(components[i]));
       		}
       	} else {
       		element = document.createElement("div");
       		element.appendChild(document.createTextNode("unknown: " + type));
       	}
       	if (content.id != undefined) {
	   		element.id = content.id;
       	}
   		return element;       		
    }

    function createFormRows(rows) {
    	var element = document.createElement("tbody");
   		for (var i = 0; i<rows.length; i++) {
   			element.appendChild(createFormRow(rows[i]));
   		}
   		return element;
    }
    function createFormRow(row) {
   		var element = document.createElement("tr");
   		for (var i = 0; i<row.length; i++) {
   			element.appendChild(createFormCell(row[i]));
   		}
   		return element;
    }
    function createFormCell(cell) {
   		var td = document.createElement("td");
   		if (cell.span != undefined) {
    		td.colSpan = cell.span;
   		}
   		var caption = document.createElement("div");
   		caption.className = "caption";
   		caption.appendChild(document.createTextNode(cell.caption));
   		var tooltip = document.createElement("img");
   		tooltip.id = cell.id + "-validation";
   		tooltip.setAttribute("src", "field_error.png");
   		tooltip.setAttribute("title", "The tooltip");
   		if (cell.validation == undefined) {
   			tooltip.className = "hide";
   		}
   		caption.appendChild(tooltip);
   		td.appendChild(caption);
   		td.appendChild(createContent(cell));
   		return td;
    }
    
    function createTableHeaders(headers) {
    	var element = document.createElement("thead");
   		for (var i = 0; i<headers.length; i++) {
   			var th = document.createElement("th");
   			th.appendChild(document.createTextNode(headers[i]));
   			element.appendChild(th);
   		}
   		return element;
    }
    function createTableRows(tableId, rows) {
    	var element = document.createElement("tbody");
   		for (var i = 0; i<rows.length; i++) {
   			var rowElement = createTableRow(rows[i]);
   			rowElement.setAttribute("onclick", "tableAction(\"" + tableId + "\", " + i + " );");
   			element.appendChild(rowElement);
   		}
   		return element;
    }
    function createTableRow(row) {
   		var element = document.createElement("tr");
   		for (var i = 0; i<row.length; i++) {
   			element.appendChild(createTableCell(row[i]));
   		}
   		return element;
    }
    function createTableCell(cell) {
   		var td = document.createElement("td");
   		if (cell != undefined) {
	   		td.appendChild(document.createTextNode(cell));
   		}
   		return td;
    }
    
   function showMenuBar(menus) {
   		var ul = document.getElementById("menu");
		while (ul.firstChild) {
			ul.removeChild(ul.firstChild);
		}
   		
   		for (var i = 0; i<menus.length; i++) {
  			var menu = menus[i];
       		var li = document.createElement("li");
       		ul.appendChild(li);
       		li.appendChild(document.createTextNode(menu.name));
       		li.appendChild(createMenu(menu));
   		}
       		
        function createMenu(menu) {
       		var ul = document.createElement("ul");

       		var items = menu.items;
       		for (var i = 0; i<items.length; i++) {
       			var item = items[i];
	       		var li = document.createElement("li");
           		ul.appendChild(li);
           		if (item.name != undefined) {
   	        		if (item.items != undefined) {
	   	        		li.appendChild(document.createTextNode(item.name));
   	            		li.appendChild(createMenu(item));
   	    			} else if (item.id != undefined) {
	   	 	       		var a = document.createElement("a");
	   	 	       		li.appendChild(a);
	   	        		a.appendChild(document.createTextNode(item.name));
   	    				li.setAttribute("onclick", "action(\"" + item.id + "\");");
   	        		}
           		} else {
           			li.appendChild(document.createElement("hr"));
           		}
   	   		}
       		return ul;
        }
	}

    function showDialog(json) {
    	var dialog = document.createElement("dialog");
    	if (dialog.show == undefined) {
	    	dialogPolyfill.registerDialog(dialog);
    	}
    	dialog.id = json.id;
   		
   		var header = document.createElement("div");
   		header.id = "dialogHeader";
   		var headerDiv = document.createElement("div");
   		headerDiv.appendChild(document.createTextNode(json.title));
   		header.appendChild(headerDiv);
       	dialog.appendChild(header);
   		
   		var content = document.createElement("div");
   		content.id = "dialogContent";
   		content.appendChild(createContent(json["content"]));
       	dialog.appendChild(content);
   		
   		var footer = document.createElement("div");
   		footer.id = "dialogFooter";
   		var actions = json["actions"];
   		for (var i = 0; i<actions.length; i++) {
   			var action = actions[i];
       		var button = document.createElement("button");
       		button.appendChild(document.createTextNode(action.name));
			button.setAttribute("onclick", "action(\"" + action.id + "\");");
			footer.appendChild(button);
	   	}
       	dialog.appendChild(footer);
       	
       	document.getElementById("all").appendChild(dialog);
       	dialog.showModal();
	}
    
    function init() {
    	websocket = new WebSocket("ws://" + location.host + "/");
    	websocket.onmessage = function(evt) {
			onMessage(evt)
		};
    	websocket.onopen = function(evt) {
			showPage();
		};    
		window.onpopstate = function(event) {
			var data = {};
			data.showPage = event.state;
			send(data);
		}
    }

	
	function sendchange(source) {
		var data = {};
		var changedValue = {};
		changedValue[source.id] = source.value;
		data.changedValue = changedValue;
		send(data);
	}
	
    function showPage() {
		var data = {};
		data.showPage = null;
		send(data);
    }
    
    function action(actionId) {
		var data = {};
		data["activatedAction"] = actionId;
		send(data);
    }

    function tableAction(tableId, row) {
		var tableAction = {};
		tableAction.table = tableId;
		tableAction.row = row;
		var data = {};
		data.tableAction = tableAction;
		send(data);
    }
    
    function search() {
		var data = {};
		data["search"] = document.getElementsByName("query")[0].value;
		send(data);
    }
    
    function send(data) {
    	if (websocket.readyState > 1) {
    		websocket = new WebSocket("ws://" + location.host + "/");
        	websocket.onmessage = function(evt) {
    			onMessage(evt)
    		};    		
    		websocket.onopen = function(evt) {
    			send(data);
    		}
    	} else {
			data["session"] = session;
			websocket.send(JSON.stringify(data));
    	}
    }

</script>
</head>
<body onload="init();">
	<div id="all">
		<div id="header">
			<div id="menu"></div>
			<div id="search">
				<input type="text" name="query" value="" /> <input type="submit" value="Search" onclick="search();"/>
			</div>
		</div>
		<div id="content">
		</div>
	</div>
</body>
</html>