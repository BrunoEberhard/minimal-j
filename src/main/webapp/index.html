<html>
<head>
<title>Loading</title>

<!-- $MINIMALJ-VERSION -->
<!-- $APPLICATION-VERSION -->
<base href="$BASE">

<!-- $CHEERPJ_IMPORT 
<script src="https://cjrtnc.leaningtech.com/loader.js"></script>
-->
<script src="dialog-polyfill.js"></script>

<link rel="stylesheet" type="text/css" href="dialog-polyfill.css" />
<link rel="stylesheet" type="text/css" href="mj.css" />
$THEME

$ICON

<script type="text/javascript">
	"use strict";

	var navigatorInfo = navigator.userAgent || navigator.vendor || window.opera; // see http://detectmobilebrowsers.com/
    var isMobile = (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(navigatorInfo) ||
        /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigatorInfo.substr(0, 4)));
  
	var websocket;
	var session = sessionStorage.sessionId;

	var pageContainerElement;
	var titleElement;
  	var intersectionObserver = new IntersectionObserver(intersectionListener, {threshold: 1});
  
	function onMessage(data) {
		var dataObject = JSON.parse(data);
		session = dataObject["session"];
		sessionStorage.sessionId = session;
		if (dataObject.title != undefined) {
			titleElement.replaceChild(document.createTextNode(dataObject.title), titleElement.firstChild);
		}
		if ("showPage" in dataObject) {
			addNewStateToHistory(dataObject.showPage.route);
			showPage(dataObject.showPage);
			saveStateInHistory();
		} else if ("showPages" in dataObject) {
			var pages = dataObject.showPages;
			for (var i = 0; i<pages.length; i++) {
				showPage(pages[i]);
			}
		} else if ("hidePage" in dataObject) {
			addNewStateToHistory();
			hidePage(dataObject.hidePage);
			saveStateInHistory();
		} else if (dataObject.pageId) {
			var title = dataObject.title;
			var pageId = dataObject.pageId;
			var pageElement = document.getElementById(pageId);
			if (pageElement != null) {
				var pageTitleElement = pageElement.querySelector(".pageTitle");
				pageTitleElement.textContent = title;
			}
		}
		if (dataObject.hideDetail != undefined) {
			addNewStateToHistory();
			var pageId = dataObject.hideDetail;
			hideDetail(pageId);
			saveStateInHistory();
		}		
		if (dataObject.navigation != undefined) {
			updateNavigation(dataObject.navigation);
		}
		if (dataObject.dialog != undefined) {
			showDialog(dataObject.dialog);
		}
		if (dataObject.closeDialog != undefined) {
			for (var i = 0; i<dataObject.closeDialog.length; i++) {
				var dialog = document.getElementById(dataObject.closeDialog[i]);
				dialog.close();
			}
		}
		if (dataObject.propertyChanges != undefined) {
			var propertyChanges = dataObject.propertyChanges;
			for ( var id in propertyChanges) {
				var element = document.getElementById(id);
				if (element != undefined) {
					for ( var property in propertyChanges[id]) {
						var value = propertyChanges[id][property];
						if (property == "tableContent") {
							while (element.getElementsByTagName("tbody").length > 0) {
								element.removeChild(element.getElementsByTagName("tbody")[0]);
							}
							element.appendChild(createTableRows(id, value));
						} else if (property == "validationMessage") {
							var validationElement = document.getElementById(id + "-validation");
							if (value == undefined || value == "") {
								validationElement.className = "hide";
							} else {
								validationElement.className = "";
								validationElement.title = value;
							}
						} else if (property == "enabled" && element.className == "list") {
							element.style.display = value ? "block" : "none";						
						} else if (property == "enabled" && element.className == "listContent") {
							element.parentElement.style.display = value ? "block" : "none";		
						} else if (property == "editable" || property == "enabled") {
							if (value) {
								element.removeAttribute("disabled");
							} else {
								element.setAttribute("disabled", "true");
							}
						} else if (property == "value" && (element.tagName == "DIV" || element.tagName == "SPAN")) {
							element.innerHTML = escapeText(value);
						} else if (property == "value" && element.tagName == "IMG") {
							element.src = "data:image;base64, " + atob(value);
						} else {
                            if (property == "value" && element.tagName == "INPUT" && element.type == "password") {
								value = value.join("");
                            }
							if (document.activeElement != element || element.id != dataObject.source) {
								element[property] = value;
							} else {
								// a date (formatted input) should not change while user is entering more characters. Wait for blur
								element.valueOnBlur = value;
							}
						}
					}
				}
			}
		}
		if (dataObject.contentChanges != undefined) {
			var contentChanges = dataObject.contentChanges;
			for ( var id in contentChanges) {
				var element = document.getElementById(id);
				if (element != undefined) {
					for (var i = 0; i < contentChanges[id].length; i++) {
						var c = contentChanges[id][i];
						if (c == "clear") {
							while (element.firstChild) {
								element.removeChild(element.firstChild);
							}
						} else {
							element.appendChild(createContent(c));
						}
					}
				}
			}
			updateDialogSizes();
		}
		if (dataObject.message != undefined) {
			alert(dataObject.message);
		}
		if (dataObject.error != undefined) {
			alert(dataObject.error);
		}
		if (dataObject.loadSuggestions != undefined) {
			var id = dataObject.loadSuggestions;
			createSuggestions(id, dataObject.suggestions);
		}
		if (dataObject.tableExtendContent != undefined) {
			var table = document.getElementById(dataObject.tableId);
			var oldScroll = table.parentNode.scrollTop;
			table.appendChild(createTableRows(dataObject.tableId, dataObject.tableExtendContent));
			if (!dataObject.extendable) {
				var footer = table.getElementsByTagName("tfoot")[0];
				intersectionObserver.unobserve(footer);
				table.removeChild(footer);			
			}
			table.parentNode.scrollTop = oldScroll;
		}
		
		var block = document.getElementById('block');
		block.classList.remove("is-blocked"); 
	}
	
	function setDeferredValue(element) {
		if (element != undefined && element.valueOnBlur != undefined) {
			element.value = element.valueOnBlur;
			element.valueOnBlur = undefined;
		}
	}
	
	function addNewStateToHistory(fragment) {
		var pages = document.getElementsByClassName("page");
		if (pages.length > 0) {
			history.pushState(null, titleElement.innerText, fragment != undefined ? fragment : "/"); // second argument is ignored by browsers (!)
		}
	}
	
	function saveStateInHistory() {
		var pages = document.getElementsByClassName("page");
		if (pages.length > 0) {
			var state = [];
			for (var i = 0; i<pages.length; i++) {
				state.push(pages[i].id);
			}
			history.replaceState(state, titleElement.innerText);
		}
	}
	
	function popState(event) {
		if (event.state) {
			var data = {"showPages" : event.state};
			send(data, true);
		}
	}
	
	function onError(evt) {
	}

	function showPage(page) {
		// only on large devices more than one page is displayed at a time
		while (pageContainerElement.lastChild && pageContainerElement.lastChild.id != page.masterPageId) {
			pageContainerElement.removeChild(pageContainerElement.lastChild);
		}
		
        closeActionMenus();
    
		var pageElement = document.createElement("div");
		pageElement.className = "page";
		pageElement.id = page.pageId;
			
		var hasActionMenu = page.actionMenu != null;
		
		// pageHeader will only be displayed on large displays
		var headerElement = createPageHeader(page.title);
		pageElement.appendChild(headerElement);
		if (!hasActionMenu) {
			var actionMenuButton = headerElement.querySelector(".actionMenuButton");
			actionMenuButton.removeAttribute("onclick");
			actionMenuButton.style.display = "none";
		}
		
		var pageContentAndActionsElement = document.createElement("div");
		pageContentAndActionsElement.className = "pageContentAndActions";

		if (page.content != null) {
			var pageContentElement = document.createElement("div");
			pageContentElement.className = "pageContent";
			
			var contentElement = createContent(page.content);
			pageContentElement.appendChild(contentElement);

			pageContentAndActionsElement.appendChild(pageContentElement);
		} else {
			pageElement.style.borderBottom = "none";
		}
		
		// actions
		document.getElementById("actionMenuButton").style.display = hasActionMenu ? null : "none";

		if (hasActionMenu) {
			var actionMenuContainer = document.createElement("div");
			actionMenuContainer.className = "actionMenuContainer";
			
			var actionMenuElement = createMenu(page.actionMenu, page.pageId);
			actionMenuElement.className = "actionMenu";
			
			if (pageContainerElement.offsetWidth < 1200) actionMenuContainer.style.display = "none";
			
			actionMenuContainer.appendChild(actionMenuElement);
			pageContentAndActionsElement.appendChild(actionMenuContainer);
		}
		
		pageElement.appendChild(pageContentAndActionsElement);
		pageContainerElement.appendChild(pageElement);
    
        if (window.innerWidth < 992) toggleNavigation("close");
    
		pageElement.scrollIntoView();
	}
	
	function hidePage(page) {
		var start = -1;
		for (var i = 0; i<pageContainerElement.childNodes.length; i++) {
			if (pageContainerElement.childNodes[i].id == page) {
				start = i;
			}
		}
		for (var i = pageContainerElement.childNodes.length -1; i>= start; i--) {
			pageContainerElement.removeChild(pageContainerElement.lastChild);
		}
	}

	function togglePageActionMenu(event) {
		var element = event.target;
		while ((element.classList == null || !element.classList.contains("page")) && (element = element.parentNode));
		if (element != null) {
			var actionMenuElement = element.querySelector(".actionMenuContainer");
			if (actionMenuElement != null) {
				if (actionMenuElement.style.display != "none") {
					actionMenuElement.style.display = "none";
				} else {
					actionMenuElement.style.display = "block";
				}
				event.preventDefault();
			}
		}
	}

	function toggleActionMenu() {
        var actionMenuElements = document.getElementsByClassName("actionMenuContainer")
		var actionMenuElement = actionMenuElements[actionMenuElements.length - 1];
		if (actionMenuElement.style.display == "block") {
			actionMenuElement.style.display = "none";
		} else {
			actionMenuElement.style.display = "block";
		}
		event.preventDefault();
	}
	
	function closeActionMenu() {
        var actionMenuElements = document.getElementsByClassName("actionMenuContainer")
		var actionMenuElement = actionMenuElements[actionMenuElements.length - 1];
		if (actionMenuElement != undefined) {
			actionMenuElement.style.display = "none";
		}
	}
	
	function togglePage(event) {
		var element = event.target;
		while ((element = element.parentNode) && element.className != "page");
		var pageContentElement = element.querySelector(".pageContentAndActions");
		if (pageContentElement.style.display == "none") {
			pageContentElement.style.display = null;
			element.scrollIntoView();
		} else {
			pageContentElement.style.display = "none";
		}
	}
	
	function closePage(event) {
		addNewStateToHistory();
		
		var element = event.target;
		while ((element = element.parentNode) && element.className != "page");
		
		var index = Array.prototype.indexOf.call(pageContainerElement.childNodes, element);
		for (var i = pageContainerElement.childNodes.length - 1; i>= index; i--) {
			var e = pageContainerElement.childNodes[i];
			pageContainerElement.removeChild(e);
		}
		
		saveStateInHistory();
		
		var data = {closePage : element.id};
		send(data, true);
	}

	function createPageHeader(title) {
		var element = document.createElement("div");
		element.className = "pageHeader";
		
		var titleElement = document.createElement("span");
		titleElement.className = "pageTitle";
		titleElement.textContent = title;
		element.appendChild(titleElement);
		
		var b = document.getElementById("pageHeaderButtons");
		var button = b.cloneNode(true);
		button.id = "menu";
		button.setAttribute("style", "position: absolute; right: 1em; top: 0.4em;"); 
		element.appendChild(button);

		return element;
	}
	
	function hideDetail(pageId) {
		var contentElement = document.getElementById(pageId);
		if (!detail) {
			while (contentElement.firstChild) {
				contentElement.removeChild(contentElement.firstChild);
			}
		}
	}
	
	function createContent(content) {
		var type = content.type;
		var element;
		var editable = content.editable == undefined || content.editable;
		if (type == "Form") {
			element = document.createElement("div");
			element.classList.add("form")	
			element.dataset.columns = content.columns ? content.columns : 1;
			element.dataset.columnWidth = content.columnWidth;
			element.style.maxWidth = (content.columns * content.columnWidth * 1.5 / 6 + 3) + "em";
			var rows = content.rows;
			for (var i = 0; i < rows.length; i++) {
				element.appendChild(createFormRow(rows[i], content.columnWidth));
			}
		} else if (type == "Query") {
			element = document.getElementById("queryCaption");
			removeChildren(element);
			element.appendChild(document.createTextNode(content.caption));
			element = document.getElementById("query").cloneNode(true);
		} else if (type == "Table") {
			element = document.createElement("table");
			element.name = content.id;
			element.classList.add("table");
			if (content.multiSelect) {
				element.classList.add("multiSelect");
			}
			if (content.overview != null) {
				var overview = document.createElement("thead");
				overview.appendChild(createContent(content.overview));
				element.appendChild(overview);
			}
			element.appendChild(createTableHeaders(content.id, content.headers));
			element.appendChild(createTableRows(content.id, content.tableContent));
			
			if (content.extendable) {
				var footer = document.createElement("tfoot");
				var dots = document.createTextNode("...");
				footer.setAttribute("onclick", "tableExtendContent(\"" + content.id + "\");");				
				footer.appendChild(dots);
				if (intersectionObserver != undefined) {
					intersectionObserver.observe(footer);
				}
				element.appendChild(footer);
			}
		} else if (type == "Text" || type == "Title") {
			element = document.createElement("div");
			element.classList.add(type);
			if (content.value != undefined) {
				element.innerHTML = escapeText(content.value);
			} else {
				element.innerHTML = "&nbsp;";
			}
		} else if (type == "Group") {
			element = document.createElement("div");
			element.classList.add("group");
			var components = content.components;
			for (var i = 0; i < components.length; i++) {
				var item = document.createElement("div");
				item.classList.add("groupItem");
				item.appendChild(createContent(components[i]));
				element.appendChild(item);
			}
		} else if (type == "Switch") {
			element = document.createElement("div");
		} else if (type == "Action") {
			element = document.createElement("div");
			element.className = "action";
			element.textContent = content.name;
			element.setAttribute("onclick", "action(\"" + content.id + "\");");
		} else if (type == "TextField") {
			element = document.createElement("input");
			try {
				element.type = content.inputType;
				if (content.inputType == "time") {
					if (content.maxLength == 8) {
						element.step = 1;
					} else if (content.maxLength == 12) {
						element.step = "0.001";
					}
				}
			} catch (err) { // happens in ie 10 for datetime-local
				element.type = "text";
			}
			element.setAttribute(element.type == "text" ? "onkeyup" : "onchange", "sendchange(this);");
			element.setAttribute("onblur", "setDeferredValue(this);");
			element.setAttribute("maxlength", content.maxLength);
			if (content.value != undefined) {
				element.value = content.value;
			}
			if (content.suggestions != undefined) {
				element.setAttribute("autocomplete", "off");
				element.setAttribute("list", content.id + "-list");
				element.setAttribute("onkeydown", "if (event.keyCode == 40) loadSuggestions(this);");
			}
		} else if (type == "AreaField") {
			element = document.createElement("textarea");
			element.setAttribute("onkeyup", "sendchange(this);");
			element.setAttribute("maxlength", content.maxLength);
			if (content.value != undefined) {
				element.value = content.value;
			}
		} else if (type == "SearchTextField") {
			element = document.createElement("input");
			element.type = "text";
			element.id = content.id;
			element.setAttribute("style", "flex-grow: 1;");
			element.setAttribute("onkeydown", "if (event.keyCode == 13) sendchange(this);");

			var button = document.createElement("button");
			button.appendChild(document.createTextNode("$SEARCH"));
			button.setAttribute("onclick", "sendchange(this.previousSibling);");
			button.setAttribute("style", "width: 10em;");

			var div = document.createElement("div");
			div.setAttribute("style", "display: flex;");
			div.appendChild(element);
			div.appendChild(button);
			return div; /* ! */
		} else if (type == "Combobox") {
			element = document.createElement("select");
			var option = document.createElement("option");
			element.appendChild(option);
			if (content.options != undefined) {
				for ( var id in content.options) {
					var option = document.createElement("option");
					option.value = id;
					option.textContent = content.options[id].text;
					var description = content.options[id].description; 
					if (description != undefined) option.title = description;
					element.appendChild(option);
				}
			}
			element.value = content.value;
			element.setAttribute("onchange", "sendchange(this);");
		} else if (type == "CheckBox") {
			element = document.createElement("input");
			element.type = "checkbox";
			if (editable) {
				element.setAttribute("onchange", "sendchange(this);");
			} else {
				element.setAttribute("disabled", "true");
			}
			element.id = content.id;
			if (content.value == "true") {
				element.setAttribute("checked", "checked");
			}
			var label = document.createElement("label");
			label.className = "checkboxLabel";
			label.appendChild(element);
			label.appendChild(document.createTextNode(content.text));
			return label; /* ! */
		} else if (type == "Lookup") {
			element = document.createElement("div");
			element.className = "lookup";
			element.appendChild(createContent(content.input));
			var button = document.createElement("button");
			button.appendChild(document.createTextNode(".."));
			button.setAttribute("onclick", "openLookupDialog(\"" + content.id + "\");");
			element.appendChild(button);
		} else if (type == "List") {
			element = document.createElement("div");
			element.id = content.id;
			if (content.actions != undefined) {
				element.className = "listContent";
				var actionElement = document.createElement("div");
				for (var i = 0; i < content.actions.length; i++) {
					actionElement.appendChild(createContent(content.actions[i]));
				}
				var elementWithActions = document.createElement("div");
				elementWithActions.appendChild(element);
				elementWithActions.appendChild(actionElement);
				element = elementWithActions;
			}
			element.className = "list";
			var enabled = content.enabled == undefined || content.enabled;
			element.style.display = enabled ? "block" : "none";
			return element;
		} else if (type == "Url") {
			element = document.createElement("iframe");
			element.setAttribute("src", content.htmlOrUrl);
			element.setAttribute("scrolling", "no");
			element.className = "urlpage";
			element.setAttribute("onload", "this.height = this.contentWindow.document.body.scrollHeight + \"px\"");
		} else if (type == "Html") {
			element = document.createElement("div");
			element.className = "htmlpage";
			element.innerHTML = content.htmlOrUrl;
		} else if (type == "Image") {
		    if (editable) {
				element = document.createElement("input");
				element.type = "file";
				element.setAttribute("onchange", "sendchange(this);");
		    } else {
		    	element = document.createElement("img");
		    	if (content.value != undefined) {
			    	element.src = "data:image;base64, " + content.value;
			    }
		    }
		} else {
			element = document.createElement("div");
			element.appendChild(document.createTextNode("unknown: " + type));
		}
		if (!editable) {
			element.setAttribute("disabled", "true");
		}
		if (content.id != undefined) {
			element.id = content.id;
		}
		return element;
	}
	
	function createFormRow(row, columnWidth) {
		var element = document.createElement("div");
		for (var i = 0; i < row.length; i++) {
			var span = row[i].span;
			span = span ? span : 1;
			var cellElement = createFormCell(row[i], span, columnWidth);
			element.appendChild(cellElement);
		}
		return element;
	}
	function createFormCell(cell, span, width) {
		var cellElement = document.createElement("div");
		var isTitle = cell.type == "Title";
		if (!isTitle && cell.caption != undefined) {
			var caption = document.createElement("label");
			caption.setAttribute("for", cell.firstId != undefined ? cell.firstId : cell.id);
			caption.appendChild(document.createTextNode(cell.caption));
			var tooltipTemplate = document.getElementById("tooltip");
			var tooltip = tooltipTemplate.cloneNode(true);
			tooltip.id = cell.id + "-validation";
			if (cell.validationMessage != undefined && cell.validationMessage.length > 0) {
				tooltip.setAttribute("title", cell.validationMessage);
				caption.setAttribute("title", cell.validationMessage);
			} else {
				tooltip.className = "hide";
			}
			caption.appendChild(tooltip);
			cellElement.appendChild(caption);
		} else {
			cellElement.style.verticalAlign = "bottom";
		}
		var cellContent = createContent(cell);
		setWidths(cellElement, cellContent, span, width);
		cellElement.appendChild(cellContent);
		return cellElement;
	}
	function setWidths(cellElement, cellContent, span, width) {
		cellElement.style.minWidth = (width / 6) + "em";
		cellElement.style.width = (width * span / 6) + "em";
		cellElement.style.flexShrink = span;
		cellElement.style.flexGrow = span;

		if (cellContent.classList.contains("group")) {
			var childCount = cellContent.children.length;
			for (var i = 0; i < childCount; i++) {
				var groupItem = cellContent.children[i];
				setWidths(groupItem, groupItem.children[0], span / childCount, width);
			}
		}
	}
	
	function createTableHeaders(tableId, headers) {
		var element = document.createElement("thead");
		for (var i = 0; i < headers.length; i++) {
			var th = document.createElement("th");
			th.appendChild(document.createTextNode(headers[i]));
			th.setAttribute("onclick", "tableSortAction(\"" + tableId + "\", " + i + " );");
			element.appendChild(th);
		}
		return element;
	}
	function createTableRows(tableId, rows) {
		var element = document.createElement("tbody");
		for (var i = 0; i < rows.length; i++) {
			var rowElement = createTableRow(rows[i]);
			rowElement.setAttribute("onmousedown", "tableSelection(event, this, " + i + ");");
			rowElement.setAttribute("ondblclick", "tableAction(\"" + tableId + "\", " + i + " );");
			element.appendChild(rowElement);
		}
		return element;
	}
	function createTableRow(row) {
		var element = document.createElement("tr");
		for (var i = 0; i < row.length; i++) {
			element.appendChild(createTableCell(row[i]));
		}
		return element;
	}
	function createTableCell(cell) {
		var td = document.createElement("td");
		if (cell != undefined) {
			td.appendChild(document.createTextNode(cell));
		}
		return td;
	}

	function removeChildren(element) {
		while (element.firstChild) {
			element.removeChild(element.firstChild);
		}
	}
	
	function updateNavigation(menus) {
		var navigationElement = document.getElementById("navigation");
		removeChildren(navigationElement);

		var menuElement = createMenu(menus);
		menuElement.style.marginTop = "0px";
		navigationElement.appendChild(menuElement);		
	}

	function createMenu(items, pageId) {
		var ul = document.createElement("ul");

		for (var i = 0; i < items.length; i++) {
			var item = items[i];
			var li = document.createElement("li");
			ul.appendChild(li);
			if (item.name != undefined) {
				if (item.items != undefined) {
					li.appendChild(document.createTextNode(item.name));
					li.appendChild(createMenu(item.items));
				} else if (item.id != undefined) {
					li.id = item.id;
					li.classList.add("action");
					li.setAttribute("onclick", "if (!this.getAttribute(\"disabled\")) action(\"" + item.id + "\");");
					li.appendChild(document.createTextNode(item.name));
					if (!item.enabled) {
						li.setAttribute("disabled", "true");
					}
				}
			} else {
				li.appendChild(document.createElement("hr"));
			}
		}
		return ul;
	}

	function toggleNavigation(openOrClose) {
		var navigationElement = document.getElementById("navigationContainer");
		var isClosed = navigationElement.style.display == "none";
		if (isClosed && (openOrClose == undefined || openOrClose == "open")) {
			navigationElement.style.display = "block";
			closeActionMenu();
		} else if (!isClosed && (openOrClose == undefined || openOrClose == "close")) {
			navigationElement.style.display = "none";
		}
	}
	
	function showDialog(json) {
		var dialog = document.createElement("dialog");
		dialog.id = json.id;
		dialog.setAttribute("type", json.type);

		var header = document.createElement("div");
		header.classList.add("dialogHeader");
		var headerDiv = document.createElement("div");
		headerDiv.appendChild(document.createTextNode(json.title));
		var	buttons = document.getElementById("dialogButtons").cloneNode(true);
		headerDiv.appendChild(buttons);
		header.appendChild(headerDiv);
		dialog.appendChild(header);

		var content = createContent(json["content"]);
		content.classList.add("dialogContent");
		dialog.appendChild(content);
		
		var actions = json["actions"];
		if (actions != undefined) {
			var footer = document.createElement("div");
			footer.classList.add("dialogFooter");
			for (var i = 0; i < actions.length; i++) {
				var action = actions[i];
				var button = document.createElement("button");
				button.id = action.id;
				button.appendChild(document.createTextNode(action.name));
				button.setAttribute("onclick", "action(\"" + action.id + "\");");
				if (!action.enabled)
					button.setAttribute("disabled", "true");
				footer.appendChild(button);
			}
			dialog.appendChild(footer);
		}
		
		var saveAction = json.saveAction;
		if (saveAction != null) {
			var inputs = content.getElementsByTagName("input");
			var lastInput = inputs[inputs.length - 1]; 
			if (lastInput != undefined && (lastInput.type == "text" || lastInput.type == "password")) {
				lastInput.setAttribute("onkeyup", "sendchange(this, event.keyCode == 13  ? \"" + saveAction.id + "\" : undefined);");
			}
		}

		var parent = document.getElementById("body");
		parent.appendChild(dialog);
		if (dialog.show == undefined) {
			dialogPolyfill.registerDialog(dialog);
        }
        
        dialog.addEventListener("close", dialogClosedListener); 
		dialog.showModal();
		updateDialogSizes();
	}
  
    function closeDialog(event) {
		var dialog = event.target;
		while (dialog.tagName.toUpperCase() != "DIALOG" && (dialog = dialog.parentNode) != null);
		dialog.close();
    }

    function dialogClosedListener(event) {
          document.getElementById("body").removeChild(event.target); 
          updateDialogSizes();
    }

	function sendchange(source, saveAction) {
		var data = {};
		var changedValue = {};
		if (source.type == "checkbox") {
			/* for checkboxes value is always true */
			changedValue[source.id] = source.checked.toString();
		} else if (source.type == "password") {
			changedValue[source.id] = source.value.split("");		
		} else if (source.type == "file") {
			var reader = new FileReader();
			reader.onload = function(e) {
				var binary = "";
				var bytes = new Uint8Array(reader.result);
           		for (var i = 0; i < bytes.byteLength; i++) {
               		binary += String.fromCharCode(bytes[i]);
           		}
		        changedValue[source.id] = btoa(binary);
		        data.changedValue = changedValue;
		        send(data, false);
		    }
			reader.readAsArrayBuffer(source.files[0]); // readAsBinaryString would be shorter but not supported on IE
			return;
		} else {
			changedValue[source.id] = source.value;
			source.valueOnBlur = undefined;
		}
		data.changedValue = changedValue;
		if (saveAction != undefined) {
			data.activatedAction = saveAction;
			send(data, true);
		} else {
			send(data, false);
		}
	}

	function loadSuggestions(source) {
		var data = {"loadSuggestions" : source.id, "searchText" : source.value};
		send(data, false);
	}
	
	function createSuggestions(id, suggestions) {
		var datalist = document.createElement("datalist");
		datalist.id = id + "-list";
		for (var i = 0; i < suggestions.length; i++) {
			var option = document.createElement("option");
			option.setAttribute("value", suggestions[i]);
			datalist.appendChild(option);
		}
		
		var input = document.getElementById(id);
		while (input.firstChild) {
			input.removeChild(input.firstChild);
		}
		input.appendChild(datalist);
	}
	
	function action(actionId) {
		closeActionMenu();
		var data = {"activatedAction" : actionId};
		send(data, true);
	}

	var lastSelectedTable;
	var lastSelectedRow;
	
	function tableSelection(event, rowElement, row) {
		if (event.button != 0) return; // only 'left' mouse button should select
		var tableElement = rowElement;
		while ((tableElement = tableElement.parentNode) && tableElement.tagName.toUpperCase() != "TABLE");

		var pageElement = tableElement;
		while ((pageElement = pageElement.parentNode) && pageElement.className != "page");
		
		var multiSelect = tableElement.classList.contains("multiSelect");
		var rows = [];
		if (multiSelect && lastSelectedTable == tableElement && event.shiftKey) {
			for (var i = 0; i < tableElement.rows.length; i++) {
				if (i < row && i < lastSelectedRow || i > row && i > lastSelectedRow) {
					tableElement.rows[i].classList.remove("selected");
				} else if (i >= row && i <= lastSelectedRow || i >= lastSelectedRow && i <= row) {
					rows.push(i);
					tableElement.rows[i].classList.add("selected");
				}
			}
		} else {
			for (var i = 0; i < tableElement.rows.length; i++) {
				if (tableElement.rows[i].classList.contains("selected")) {
					if (multiSelect && event.ctrlKey) {
						rows.push(i);
					} else {
						tableElement.rows[i].classList.remove("selected");
					}
				}
			}
			rows.push(row);
			tableElement.rows[row].classList.add("selected");
		}
		lastSelectedTable = tableElement;
		lastSelectedRow = row;
		
		var tableAction = {"table" : tableElement.id, "rows" : rows};
		var data = {"tableSelection" : tableAction};
		send(data, false);
		
		if (event.shiftKey || event.ctrlKey) {
			event.preventDefault();
		}
	}

	function tableAction(tableId, row) {
		var tableElement = document.getElementById(tableId);
		var pageElement = tableElement;
		while ((pageElement = pageElement.parentNode) && pageElement.className != "page");
		
		var tableAction = {"table" : tableId, "row" : row};
		var data = {"tableAction" : tableAction};
		send(data, true);
	}

	function tableSortAction(tableId, column) {
		var tableElement = document.getElementById(tableId);
		var pageElement = tableElement;
		while ((pageElement = pageElement.parentNode) && pageElement.className != "page");
		
		var tableAction = {"table" : tableId, "column" : column};
		var data = {"tableSortAction" : tableAction};
		send(data, true);
	}
	
	function intersectionListener(entries) {
		for (var i = 0; i<entries.length; i++) {
			if (entries[i].intersectionRatio > 0) {
				var table = entries[i].target.parentNode;
				// only a table in last page should scroll automatically
				var pages = document.getElementsByClassName("page");
				if (pages[pages.length-1].contains(table)) {
					tableExtendContent(table.name);
				}
			}
		}
	}
	
	function tableExtendContent(tableId) {
		var data = {"tableExtendContent" : tableId};
		send(data, true);
	}
	
	function openLookupDialog(lookup) {
		send({"openLookupDialog" : lookup}, true);
	}	
	
	function search() {
		var searchElement = document.getElementById("search");
		if (searchElement.style.display == "none") {
			searchElement.style.display = "";
			searchElement.value = "";
			searchElement.focus();
		} else {
			var search = searchElement.value;
			if (search != undefined && search.length > 0) {
				var data = {"search" : search};
				send(data, true);
			} else {
				searchElement.style.display = "none";
			}
		}
	}

	function querySearch() {
		var searchElement = document.getElementById("querySearch");
		var search = searchElement.value;
		if (search != undefined && search.length > 0) {
			var data = {"search" : search};
			send(data, true);
		}
	}
	
	function searchButtonAction() {
		var searchElement = document.getElementById("search");
		if (searchElement.style.display == "inline") {
			searchElement.style.display = "none";
		} else {
			searchElement.style.display = "inline";
			searchElement.focus();
		}
	}
	
	function send(data, block) {
		data.locale = "$LOCALE";
	    data.inputTypes = isMobile && checkInput("date");
	    	
		var dialogElements = document.getElementsByTagName("dialog");
		data.dialogVisible = dialogElements != undefined && dialogElements.length > 0;
		
		// $CHEERPJ
		// sendCheerpj(data, block);
		$WEB_SOCKET ? sendWebSocket(data, block) : sendAjax(data, block);
	}
		
	function sendAjax(data, block) {
		data.session = session;

		var xmlhttp = new XMLHttpRequest();
		xmlhttp.open("POST", "ajax_request.xml", !block);
		
		if (block) {
			xmlhttp.send(JSON.stringify(data));
			if (xmlhttp.readyState == 4) {
				if (xmlhttp.status == 200) {
					onMessage(xmlhttp.responseText);
				} else {
					alert('Something is wrong !!');
				}
			}
		} else {
			xmlhttp.onreadystatechange = function() {
				if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
					onMessage(xmlhttp.responseText);
				}
			}
			xmlhttp.send(JSON.stringify(data));
		}
	}
	
	function sendWebSocket(data, block) {
		if (websocket == null || websocket.readyState > 1) {
			var pathname = location.pathname;
			var index = pathname.lastIndexOf("/");
			pathname = pathname.substring(0, index + 1);
			
			var wsProtocol = window.location.protocol == "https:" ? "wss" : "ws";
			var hostAndPort = location.host + "$PORT";
			var socketUrl = wsProtocol + "://" + hostAndPort + pathname + "$WS";
			websocket = new WebSocket(socketUrl);
			websocket.onmessage = function(evt) {
				onMessage(evt.data)
			};
			websocket.onopen = function(evt) {
				send(data, block);
			}
		} else {
			if (block) {
				var block = document.getElementById("block");
				block.classList.add("is-blocked");
			}
			websocket.send(JSON.stringify(data));
		}
	}
		
	function sendCheerpj(data, block) {
		var sendStr = JSON.stringify(data);
		console.log("send");
		console.log(sendStr);
		cjCall("org.minimalj.frontend.impl.cheerpj.Cheerpj", "receiveMessage", sendStr).then(receive);
	}	
		
	function receive(e) {
		var resultStr = cjStringJavaToJs(e);
		console.log("receive");
		console.log(resultStr);
		onMessage(resultStr);
	}		
		
	function updateDialogSizes() {
		var dialogElements = document.getElementsByTagName("dialog");
		if (dialogElements != undefined && dialogElements.length > 0) {
            var maxDialogWidth = 0;
            for (var i = 0; i < dialogElements.length; i++) {
                var dialogElement = dialogElements[i];
				var maxWidthElement = dialogElement.querySelector(".form");
				if (maxWidthElement != undefined) {
                      var columns = maxWidthElement.dataset.columns;
                      dialogElement.style.maxWidth = (columns * maxWidthElement.dataset.columnWidth / 6 + 3) + "em";
                      maxDialogWidth = Math.max(maxDialogWidth, parseInt(window.getComputedStyle(dialogElement).maxWidth));
				} else {
                      dialogElement.style.maxWidth = "unset";
                }
            }
			
            if (maxDialogWidth < window.innerWidth - 20) {
                var marginLeft = 0;
				var navigationContainer = document.getElementById("navigationContainer");
                if (navigationContainer.display != "none" && navigationContainer.clientWidth + maxDialogWidth < window.innerWidth) {
                    marginLeft += navigationContainer.clientWidth;
                }

				for (var i = 0; i < dialogElements.length; i++) {
					var dialogElement = dialogElements[i];
                    dialogElement.classList.remove("fullscreen");
                    
					dialogElement.style.top = (i + 4) + "em";
					dialogElement.style.left = (i + 1) + "em";
                    dialogElement.style.width = "unset";

					dialogElement.style.marginLeft = marginLeft;
					dialogElement.style.marginRight = "1em";
					dialogElement.style.marginBottom = "1em";
					
                    var headerHeight = document.getElementById("header").clientHeight;
                    var dialogHeaderHeight = dialogElement.querySelector(".dialogHeader").clientHeight;
                    var dialogFooterHeight = dialogElement.querySelector(".dialogFooter") != null ? dialogElement.querySelector(".dialogFooter").clientHeight : 0;
                    var top = parseInt(window.getComputedStyle(dialogElement).top);
                    var dialogPadding = parseInt(window.getComputedStyle(dialogElement).marginTop) + parseInt(window.getComputedStyle(dialogElement).marginBottom);
					var contentElement = dialogElement.querySelector(".dialogContent");
					var height = Math.max(100, height = window.innerHeight - 10 - headerHeight - top - dialogPadding - dialogHeaderHeight - dialogFooterHeight);
					contentElement.style.maxHeight = height + "px";

					var type = dialogElement.getAttribute("type");
					if (type == "SearchDialog") {
						contentElement.style.height = height + "px";
						dialogElement.style.marginRight = "3em";
						contentElement.style.paddingRight = "0em";
					}
					
					dialogElement.style.display = "block";
				}
			} else {
                for (var i = 0; i < dialogElements.length - 1; i++) {
                    dialogElements[i].style.display = "none";
                }
                var dialogElement = dialogElements[dialogElements.length - 1];
                dialogElement.classList.add("fullscreen");
				dialogElement.style.display = "block";

                dialogElement.style.top = "0em";
                dialogElement.style.left = "0em";
          
                dialogElement.style.marginLeft = "0em";
                dialogElement.style.marginRight = "0em";
                dialogElement.style.marginBottom = "0em";
          
				dialogElement.style.width = "100%";
				dialogElement.style.maxWidth = null;
        
                var dialogHeaderHeight = dialogElement.querySelector(".dialogHeader").clientHeight;
                var dialogFooterHeight = dialogElement.querySelector(".dialogFooter") != null ? dialogElement.querySelector(".dialogFooter").clientHeight : 0;

                var dialogPadding = parseInt(window.getComputedStyle(dialogElement).padding);
                var contentElement = dialogElement.querySelector(".dialogContent");
                var height = window.innerHeight - dialogHeaderHeight - dialogFooterHeight - 2 * dialogPadding;
                
                contentElement.style.maxHeight = height;
			}
      
			dialogElement.style.height = "unset";
		}
	}

    function closeActionMenus() {
        var actionMenuElements = document.getElementsByClassName("actionMenuContainer"); 
        for (var i = 0; i < actionMenuElements.length; i++) {
          var actionMenuElement = actionMenuElements[i];
          actionMenuElement.style.display = "none";
        }
    }
    
    var lastWidth = 10000;
    
    function resizeNavigation() {
        var newWidth = window.innerWidth;
        if (lastWidth > newWidth && newWidth < 800) {
			toggleNavigation("close");
            // document.getElementById("search").style.display = "none";      
        } else if (lastWidth < newWidth && newWidth >= 1200) {
            toggleNavigation("open");
        }
        lastWidth = newWidth;
        
    }

	function changeLogin() {
		send({
			"login" : "login-" + (new Date().getTime())
		}, true);
	}

    function init(e) {
   		init();
	}

	function init() {
		if (!$LOGIN) {
			document.getElementById("loginButton").parentNode.removeChild(document.getElementById("loginButton"));
		}

		pageContainerElement = document.getElementById("pageContainer");
		titleElement = document.getElementsByTagName("title")[0];
		
		if (window.innerWidth >= 992) toggleNavigation("open");
    
		window.addEventListener("resize", updateDialogSizes);
        window.addEventListener("resize", closeActionMenus);
        window.addEventListener("resize", resizeNavigation);

        if ("$DISABLED_SEARCH" == "disabled") document.getElementById("searchButton").style.display = "none";

		window.onpopstate = popState;

		if (window.history.state != undefined) {
			send({ "initialize" : window.history.state });
		} else {
			send({ "initialize" : "$PATH" });
		}
	}
	
	function checkInput(type) {
	    var input = document.createElement("input");
	    input.setAttribute("type", type);
	    return input.type == type;
	}
	
	function escapeText(s) {
	  return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;").replace(/\n/g, "<br>");
	}
		
	if (false) { // $CHEERPJ, $CHEERPJ_PATH, $CHEERPJ_MAIN
		cheerpjInit();
		// cheerpjRunMain("org.minimalj.frontend.impl.cheerpj.Cheerpj", "/app/m.jar:/app/h.jar", "org.minimalj.example.helloworld2.GreetingApplication");  
        cheerpjRunMain("org.minimalj.frontend.impl.cheerpj.Cheerpj", "/app/m.jar:/app/mem.jar:/app/ech.jar", "ch.openech.OpenEchApplication").then(init);  
        // cheerpjRunMain("org.minimalj.frontend.impl.cheerpj.Cheerpj", "/app/m.jar:/app/mem.jar:/app/ech.jar", "ch.openech.OpenEchApplication", "-DMjRepository=org.minimalj.repository.memory.InMemoryRepository", "-DMjUserFile=users.txt", "-DMjDevMode=true");  
	}
	
</script>
<meta name="viewport" content="width=device-width, minimum-scale=1, user-scalable=no" />
</head>
<body onload="init();" id="body">
	<div id="header">
		<svg class="button headerButton" style="margin-left: 1.0em;" onclick="toggleNavigation()">
              <g style="stroke-width:0px"> 		
  				<title>Show or hide navigation</title>
				<rect x="0" y="5%" width="100%" height="0.25em"/>
				<rect x="0" y="40%" width="100%" height="0.25em"/>
				<rect x="0" y="75%" width="100%" height="0.25em"/>
			</g>
		</svg>
		<svg id="loginButton" class="button headerButton" onclick="changeLogin()">
			<g style="stroke-width:16%;stroke-linecap:square"> 	
                  <title>Login</title>	
				<line x1="70%" y1="8%" x2="91%" y2="8%" />
				<line x1="70%" y1="91%" x2="91%" y2="91%" />
				<line x1="91%" y1="8%" x2="91%" y2="91%" />
				
				<line x1="0%" y1="50%" x2="55%" y2="50%" />
				<line x1="40%" y1="30%" x2="60%" y2="50%" />
				<line x1="40%" y1="70%" x2="60%" y2="50%" />
			</g>
		</svg>
		<span id="pageTitle" style="padding-left: 1em; padding-bottom: 0.5em;"></span>
		<div class="button" id="searchSpan">
			<input type="search" id="search" onkeydown="if (event.keyCode == 13) search();" $DISABLED_SEARCH />
			<svg id="searchButton" class="headerButton" onclick="searchButtonAction();">
				<g style="stroke-width:16%;stroke-linecap:square"> 		
					<line x1="59%" y1="59%" x2="91%" y2="91%" />
					<circle cx="37%" cy="37%" r="30%" stroke-width="14%" fill="none" />
				</g>
			</svg>
			<svg id="actionMenuButton" class="headerButton" onclick="toggleActionMenu();">
				<g style="stroke-width:0px"> 		
					<rect x="12px" y="5%" width="3px" height="3px"/>
					<rect x="12px" y="40%" width="3px" height="3px"/>
					<rect x="12px" y="75%" width="3px" height="3px"/>
				</g>
			</svg>
		</div>			
	</div>
	<div id="container">
		<div id="navigationContainer" style="display: none;">
			<div id="navigationHeader">
				<svg class="pageButton button" style="position: absolute; right: 1em; top: 0.4em;" onclick="toggleNavigation()">
				  <line x1="7%" y1="7%" x2="93%" y2="93%" style="stroke-width:20%" />
				  <line x1="7%" y1="93%" x2="93%" y2="7%" style="stroke-width:20%" />
				</svg>
			</div>
			<div id="navigation">
			</div>
		</div>
		<div id="pageContainer" onContextmenu="togglePageActionMenu(event);">
		</div>
	</div>


	<div id="templates" style="display: none">
		<div id="pageHeaderButtons">
			<svg style="stroke-width:0px" class="actionMenuButton pageButton button" onclick="togglePageActionMenu(evt);">
				<rect x="73%" y="13%" width="20%" height="17%"/>
				<rect x="73%" y="46%" width="20%" height="17%"/>
				<rect x="73%" y="80%" width="20%" height="17%"/>
			</svg><svg class="pageButton button" onclick="togglePage(evt);">
			  <rect x="20%" y="80%" width="100%" height="13%" />
			</svg><svg class="pageButton button" onclick="closePage(evt);">
				<line x1="7%" y1="7%" x2="93%" y2="93%" style="stroke-width:20%" />
				<line x1="7%" y1="93%" x2="93%" y2="7%" style="stroke-width:20%" />
			</svg>
		</div>
		<div id="dialogButtons">
			<svg class="pageButton button" style="position: absolute; right: 1em; top: 0.5em;" onclick="closeDialog(evt)">
			  <line x1="14%" y1="14%" x2="86%" y2="86%" style="stroke-width:16%" />
			  <line x1="14%" y1="86%" x2="86%" y2="14%" style="stroke-width:16%" />
			</svg>
		</div>
		<span id="tooltip">
			<svg width="0.75em" height="0.75em" style="padding-left: 0.3em">
	  		  <circle cx="50%" cy="50%" r="49%" stroke-width="1%" fill="red" />
	  		  <rect x="38%" y="15%" width="24%" height="37%" style="fill:white;" />
	  		  <rect x="38%" y="65%" width="24%" height="20%" style="fill:white;" />
			</svg>		
		</span>
		<div id="query">
			<div id="queryCaption" style="text-align: center; margin-top: 17em"></div>
			<div style="text-align: center; margin-top: 1em; margin-bottom: 8em"><input type="text" id="querySearch" onkeydown="if (event.keyCode == 13) { querySearch() }" style="width:600px; max-width: 600px; height: 2em;"></div>
		</div>
	</div>
			

	<div id="block">
		
	</div>
</body>
</html>