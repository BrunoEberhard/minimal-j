<html lang="$LANG">
<head>
<meta charset="utf-8">
<title>$TITLE</title>
$META

<!-- Minimal-J Version: $MINIMALJ-VERSION -->
<!-- Application Version: $APPLICATION-VERSION -->
$BASE

$IMPORT

<link rel="stylesheet" type="text/css" href="mj.css" />
$THEME

$ICON

<script type="text/javascript">
	"use strict";
	
	var navigatorInfo = navigator.userAgent || navigator.vendor || window.opera; // see http://detectmobilebrowsers.com/
	var isMobile = (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(navigatorInfo) ||
		/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigatorInfo.substr(0, 4)));
	
	var websocket;
	var session = sessionStorage.sessionId;
	
	var pageContainerElement;
	var titleElement;
	
	var blockStyle = document.createElement('style');
	blockStyle.innerHTML = ".is-blocked {display: block; position: fixed; top: 0; right: 0; bottom: 0; left: 0; z-index: 90;}";
	var pendingRequests = 0;
	
	if (typeof HTMLDialogElement !== 'function') {
		// some old safari browser still need this. Maybe remove it in 2024
		import('./dialog-polyfill.js');
	    var head = document.getElementsByTagName('head')[0];
	    var style = document.createElement('link');
	    style.href = 'dialog-polyfill.css'; style.type = 'text/css'; style.rel = 'stylesheet';
	    head.append(style);
	}
	
	function onMessage(data) {
		var dataObject = JSON.parse(data);
	
		if (dataObject.wait) {
			var data = {
				"retry": dataObject.wait
			};
			document.getElementById("wait").style.width = (1 + (dataObject.wait - 1) % 3) + "em";
			send0(data);
			return;
		} else {
			document.getElementById("wait").style.width = 0;
			unblockUi();
		}
	
		session = dataObject["session"];
		var sessionChanged = sessionStorage.sessionId != undefined && session != sessionStorage.sessionId;
		sessionStorage.sessionId = session;
		if (sessionChanged) {
			location.reload();
			return;
		}
	
		if (dataObject.rememberMeToken != undefined) {
			if (dataObject.rememberMeToken != "") {
				localStorage.rememberMeToken = dataObject.rememberMeToken;
			} else {
				localStorage.removeItem("rememberMeToken");
			}
		}
	
		if (dataObject.title) {
			titleElement.replaceChild(document.createTextNode(dataObject.title), titleElement.firstChild);
		}
		if (dataObject.hasSearchPages === true) {
			document.getElementById("search").removeAttribute("disabled");
			document.getElementById("searchButton").classList.remove("hide");
		} else if (dataObject.hasSearchPages === false) {
			document.getElementById("search").setAttribute("disabled", "true");
			document.getElementById("searchButton").classList.add("hide");
		}		
		if ("showPage" in dataObject) {
			closeDialogs();
			dataObject.closeDialog = undefined;
			addNewStateToHistory(dataObject.showPage.route);
			showPage(dataObject.showPage);
			updatePageButtons();
			resizeNavigation();
			saveStateInHistory();
		} else if ("updatePage" in dataObject) {
			closeDialogs();
			dataObject.closeDialog = undefined;
			showPage(dataObject.updatePage);
			updatePageButtons();
			resizeNavigation();
		} else if ("showPages" in dataObject) {
			var pages = dataObject.showPages;
			for (var i = 0; i < pages.length; i++) {
				showPage(pages[i]);
			}
			updatePageButtons();
			resizeNavigation();
		} else if ("hidePage" in dataObject) {
			addNewStateToHistory();
			hidePage(dataObject.hidePage);
			saveStateInHistory();
			updatePageButtons();
			resizeNavigation();
		} else if ("showUrl" in dataObject) {
			window.location.href = dataObject.showUrl;
		} else if (dataObject.pageId) {
			var title = dataObject.title;
			var pageId = dataObject.pageId;
			var pageElement = document.getElementById(pageId);
			if (pageElement) {
				var pageTitleElement = pageElement.querySelector(".pageTitle");
				pageTitleElement.textContent = title;
			}
		}
		if (dataObject.hideDetail) {
			addNewStateToHistory();
			var pageId = dataObject.hideDetail;
			hideDetail(pageId);
			saveStateInHistory();
		}
		if ("horizontalDetailLayout" in dataObject) {
			var horizontalDetailLayout = dataObject.horizontalDetailLayout;
			pageContainer.style.flexDirection = horizontalDetailLayout ? "row" : "column";
			updatePageButtons();
		}
		if (dataObject.navigation) {
			updateNavigation(dataObject.navigation);
		}
		if (dataObject.dialog) {
			showDialog(dataObject.dialog);
		}
		if (dataObject.closeDialog) {
			for (var i = 0; i < dataObject.closeDialog.length; i++) {
				var dialog = document.getElementById(dataObject.closeDialog[i]);
				dialog.close();
			}
		}
		if (dataObject.propertyChanges) {
			var propertyChanges = dataObject.propertyChanges;
			for (var id in propertyChanges) {
				var element = document.getElementById(id);
				if (element) {
					for (var property in propertyChanges[id]) {
						var value = propertyChanges[id][property];
						if (property === "tableContent") {
							var tbody = element.tBodies[0];
							removeChildren(tbody);
							addTableRows(id, tbody, value);
						} else if (property === "selectedRows") {
							var tbody = element.getElementsByTagName("tbody")[0];
							for (var i = 0; i < tbody.childNodes.length; i++) {
								tbody.childNodes[i].className = value[i];		
							}					
						} else if (property === "paging") {
							var tfoot = element.tFoot;
							removeChildren(tfoot);
							addTableFooter(tfoot, value);
						} else if (property === "validationMessage") {
							var element = document.getElementById(id);
							if (value) {
								element.title = value;
							} else {
								element.removeAttribute("title");
							}
						} else if (property === "enabled" && element.className === "list") {
							element.style.display = value ? "block" : "none";
						} else if (property === "enabled" && element.className === "listContent") {
							element.parentElement.style.display = value ? "block" : "none";
						} else if (property === "editable" || property === "enabled") {
							var label = document.querySelectorAll('[for="' + id + '"]');
							if (value) {
								element.removeAttribute("disabled");
								if (label.length > 0) {
									label[0].removeAttribute("disabled");
								}
							} else {
								element.setAttribute("disabled", true);
								if (label.length > 0) {
									label[0].setAttribute("disabled", true);
								}
							}
						} else if (property === "hideFormElement") {
							var formElement = document.getElementById(id + "-element");
							if (value) {
								formElement.classList.add("hideFormElement");
							} else {
								formElement.classList.remove("hideFormElement");
							}
						} else if (property === "value" && element.tagName === "INPUT" && element.type === "checkbox") {
							element.checked = value ? "checked" : "";
						} else if (property === "value" && (element.tagName === "DIV" || element.tagName === "SPAN")) {
							element.innerHTML = value != null ? escapeText(value) : "";
						} else if (property === "value" && element.tagName === "IMG") {
							element.style.display = value ? "block" : "none";
							element.src = "data:image;base64, " + value;
						} else {
							if (property === "value" && element.tagName === "INPUT" && element.type === "password") {
								value = value.join("");
							}
							if (document.activeElement != element || element.id != dataObject.source || element.changeOnFocus) {
								// a date (formatted input) should not change while user is entering more characters
								element[property] = value;
							} else {
								element.valueOnBlur = value;
							}
						}
					}
				}
			}
		}
		if (dataObject.contentChanges) {
			var contentChanges = dataObject.contentChanges;
			for (var id in contentChanges) {
				var element = document.getElementById(id);
				if (element) {
					for (var i = 0; i < contentChanges[id].length; i++) {
						var c = contentChanges[id][i];
						if (c === "clear") {
							while (element.firstChild) {
								element.removeChild(element.firstChild);
							}
						} else {
							element.appendChild(createContent(c));
						}
					}
				}
			}
		}
		if (dataObject.message) {
			alert(dataObject.message);
		}
		if (dataObject.error) {
			alert(dataObject.error);
		}
		if (dataObject.loadSuggestions) {
			var id = dataObject.loadSuggestions;
			createSuggestions(id, dataObject.suggestions);
		}
		if (dataObject.canLogin != undefined) {
			document.getElementById("login").style.display = dataObject.canLogin ? "inline-block" : "none";
		}
		if (dataObject.canLogout != undefined) {
			document.getElementById("logout").style.display = dataObject.canLogout ? "inline-block" : "none";
		}
	}
	
	function setDeferredValue(element) {
		if (element.valueOnBlur) {
			element.value = element.valueOnBlur;
			element.valueOnBlur = undefined;
		}
	}
	
	var timerTextFieldChange = null;
	var lastChangedTextField = null;
	
	function ontextchange(element) {
		if (timerTextFieldChange) {
			clearTimeout(timerTextFieldChange);
			timerTextFieldChange = null;
			sendchange(element);
		}
		lastChangedTextField = null;
	}
	
	function ontextinput(element) {
		element.valueOnBlur = null;
		if (element !== lastChangedTextField) {
			ontextchange(lastChangedTextField);
			sendchange(element);
			lastChangedTextField = element;
		} else {
			clearTimeout(timerTextFieldChange);
			timerTextFieldChange = setTimeout(ontimeout, 500);
		}
	}
	
	function ontimeout() {
		sendchange(lastChangedTextField);
		timerTextFieldChange = null;
	}
	
	function addNewStateToHistory(fragment) {
		var pages = document.getElementsByClassName("page");
		if (pages.length > 0) {
			history.pushState(null, titleElement.innerText, fragment ? "." + fragment : ""); // second argument is ignored by browsers (!)
		}
	}
	
	function saveStateInHistory() {
		var pages = document.getElementsByClassName("page");
		if (pages.length > 0) {
			var state = [];
			for (var i = 0; i < pages.length; i++) {
				state.push(pages[i].id);
			}
			history.replaceState(state, titleElement.innerText);
		}
	}
	
	function popState(event) {
		if (event.state) {
			var data = {
				"showPages": event.state
			};
			send(data, true);
		}
	}
	
	function onError(evt) {}
	
	function showPage(page) {
		// only on large devices more than one page is displayed at a time
		while (pageContainerElement.lastChild && pageContainerElement.lastChild.id != page.masterPageId) {
			pageContainerElement.removeChild(pageContainerElement.lastChild);
		}
	
		var pageElement = document.createElement("div");
		pageElement.classList.add("page");
		if (page.className) {
		    // undefined for login page, see JsonPageManager.showLogin
			pageElement.classList.add(page.className);
		}
		pageElement.id = page.pageId;
	
		var hasActionMenu = page.actionMenu != null;
	
		// pageHeader will only be displayed on large displays
		var headerElement = createPageHeader(page);
		pageElement.appendChild(headerElement);
		if (!hasActionMenu) {
			headerElement.querySelector(".sideBarActionButton").style.display = "none";
		}
	
		var pageContentAndActionsElement = document.createElement("div");
		pageContentAndActionsElement.className = "pageContentAndActions";
		pageElement.appendChild(pageContentAndActionsElement);
	
		var pageContent = document.createElement("div");
		pageContent.className = "pageContent";
		pageContentAndActionsElement.appendChild(pageContent);
		
		pageContainerElement.appendChild(pageElement);
	
		if (page.content) {
			var contentElement;
			if (page.content.type === "Html") {
				contentElement = document.createElement("iframe");
				// the iframe must be already attached to have the document
				pageContent.appendChild(contentElement);
				if (!!("srcdoc" in contentElement)) {
					// in chrome this works best
					contentElement.srcdoc = page.content.htmlOrUrl;
				} else {
					// in IE before chromium this allows back after a link in the content was clicked
					contentElement.contentWindow.document.write(page.content.htmlOrUrl);
				}
				contentElement.height = contentElement.contentWindow.document.firstChild.scrollHeight + "px";
			} else {
				var contentElement = createContent(page.content);
				pageContent.appendChild(contentElement);
			}
			contentElement.classList.add("content" + page.content.type);
			
			headerElement.ondblclick = function(e) { selectAll(contentElement); }
			// :not([type='hidden']) is not supported on old browsers but there shoul be no hidden input anyway
			var inputs = contentElement.querySelectorAll("input, textarea, select");
			if (inputs.length > 0) {
				inputs[0].focus();
			}

			contentElement.style.minWidth = page.minWidth;
			contentElement.style.maxWidth = page.maxWidth;
		} else {
			pageElement.style.borderBottom = "none";
		}
	
		// actions
		document.getElementById("sideBarActionButton").style.display = hasActionMenu ? null : "none";
	
		if (hasActionMenu) {
			var sideBarElement = createMenu(page.actionMenu, page.pageId);
			sideBarElement.classList.add("actionSideBar");
			sideBarElement.classList.add("hidden-print");
	
			pageContentAndActionsElement.appendChild(sideBarElement);
		}
	
		if (window.innerWidth < 992) toggleNavigation("close");
	
		pageElement.scrollIntoView();;
		
		if (page.wheel) {
			var wheelListener = function(event) {
				if (event.deltaY != 0) {
					if (!event.shiftKey) {
						var data = { page: page.pageId, wheel: (event.deltaY < 0 ? -1 : 1)};
						send(data, true);
						event.preventDefault();
					} else {
						event.shiftKey = false;
					}
				}
			}
			pageElement.addEventListener("wheel", wheelListener);
		}
	}
	
	function hidePage(page) {
		var start = -1;
		for (var i = 0; i < pageContainerElement.childNodes.length; i++) {
			if (pageContainerElement.childNodes[i].id == page) {
				start = i;
			}
		}
		for (var i = pageContainerElement.childNodes.length - 1; i >= start; i--) {
			pageContainerElement.removeChild(pageContainerElement.lastChild);
		}
	}
	
	function selectAll(element) {
		var range = document.createRange(); 
		range.selectNodeContents(element);
		window.getSelection().removeAllRanges();
		window.getSelection().addRange(range);
	}
	
	function updatePageButtons() {
		var verticalLayout = pageContainer.style.flexDirection == "column";
	    var pages = document.getElementsByClassName("page");
		for (var i = 0; i < pages.length; i++) {
			pages[i].querySelector(".toggleButton").style.display = verticalLayout && i < pages.length - 1 ? "inline-block" : "none";
			pages[i].querySelector(".closeButton").style.display = i > 0 ? "inline-block" : "none";
		}
	}

	function toggleActionSideBar(event) {
		var pageElement = getPageElement(event);
		var sideBarElement = pageElement.querySelector(".actionSideBar");
		sideBarElement.classList.toggle("hide");
	}
	
	function showContextMenu(event) {
		var pageElement = getPageElement(event);
		var pageContentAndActionsElement = pageElement.querySelector(".pageContentAndActions");
		var sideBarElement = pageElement.querySelector(".actionSideBar");
		var contextMenuElement = sideBarElement.cloneNode(true);
		contextMenuElement.className = "contextMenu";

		pageContentAndActionsElement.appendChild(contextMenuElement);

		contextMenuElement.style.left = event.x;
		if (event.x + contextMenuElement.offsetWidth > window.innerWidth) {
			contextMenuElement.style.left = Math.max(0, window.innerWidth - contextMenuElement.offsetWidth);
		}
		contextMenuElement.style.top = event.y;
		contextMenuElement.style.maxHeight = "unset";
		if (event.y + contextMenuElement.offsetHeight > window.innerHeight - 30) {
			contextMenuElement.style.top = Math.max(30, window.innerHeight - contextMenuElement.offsetHeight);
			contextMenuElement.style.maxHeight = window.innerHeight - 70;
		}
		event.preventDefault();
		event.stopPropagation();
	}
	
	function getPageElement(event) {
		var pageElement = event.target;
		while ((pageElement.classList == null || !pageElement.classList.contains("page")) && (pageElement = pageElement.parentNode));
		if (!pageElement) {
		    var pageElements = document.getElementsByClassName("page");
			pageElement = document.getElementsByClassName("page")[pageElements.length - 1];
		}
		return pageElement;
	}
	
	function closeActionMenu(event) {
	    var contextMenus = document.getElementsByClassName("contextMenu");
	    for (var i = 0; i < contextMenus.length; i++) {
	    	contextMenus[i].parentNode.removeChild(contextMenus[i]);
	    }
	    var dropdowns = document.getElementsByClassName("dropdown");
	    for (var i = 0; i < dropdowns.length; i++) {
	      dropdowns[i].style.display = "none";
	    }
	}
	
	function togglePage(event) {
		var element = event.target;
		while ((element = element.parentNode) && !element.classList.contains("page"));
		var pageElement = element;
		if (pageElement.style.flexGrow == "0") {
			pageElement.style.flexGrow = "1";
			element.scrollIntoView();
		} else {
			pageElement.style.flexGrow = "0";
		}
	}
	
	function closePage(event) {
		addNewStateToHistory();
	
		var element = event.target;
		while ((element = element.parentNode) && !element.classList.contains("page"));
	
		var index = Array.prototype.indexOf.call(pageContainerElement.childNodes, element);
		for (var i = pageContainerElement.childNodes.length - 1; i >= index; i--) {
			var e = pageContainerElement.childNodes[i];
			pageContainerElement.removeChild(e);
		}
	
		saveStateInHistory();
		
		updatePageButtons();
		
		var data = {
			closePage: element.id
		};
		send(data, true);
	}
	
	function toggleFilter(event) {
		var element = getPageElement(event);
		var columnFiltersElement = element.querySelector(".columnFilters");
		columnFiltersElement.classList.toggle("hide");
		var table = element.querySelector("table");
		var data = {
			tableFilter: table.id,
			filter: !columnFiltersElement.classList.contains("hide")
		};
		send(data, true);
	}
	
	function tablePage(event, direction) {
		var element = event.target;
		while ((element = element.parentNode) && !element.classList.contains("page"));
		var table = element.querySelector("table");
		var data = {
			tablePage: table.id,
			direction: direction
		};
		send(data, true);
	}
	
	function createPageHeader(page) {
		var element = document.createElement("div");
		element.className = "pageHeader secondHeader";
	
		var titleElement = document.createElement("span");
		titleElement.className = "pageTitle";
		titleElement.textContent = page.title;
		element.appendChild(titleElement);
	
		var isTable = page.content != null && page.content.type === "Table";
		if (isTable) {
			document.getElementById("tablePageHeaderButtons").childNodes.forEach(function(item) {
		    	element.appendChild(item.cloneNode(true));
			});
			document.getElementById("tableFilterButton").classList.remove("hide");
			
			var download = element.querySelector('.downloadButton a');
			download.setAttribute("href", "/download/" + page.title + ".csv?component=" + page.content.id + "&session=" + session);
		} else {
			document.getElementById("tableFilterButton").classList.add("hide");
		}		
		
		document.getElementById("pageHeaderButtons").childNodes.forEach(function(item) {
	    	element.appendChild(item.cloneNode(true));
		});
	
		return element;
	}
	
	function hideDetail(pageId) {
		var contentElement = document.getElementById(pageId);
		if (!detail) {
			while (contentElement.firstChild) {
				contentElement.removeChild(contentElement.firstChild);
			}
		}
	}
	
	function createContent(content) {
		var type = content.type;
		var element;
		var editable = content.editable == undefined || content.editable;
		if (type === "Form") {
			element = document.createElement("div");
			element.classList.add("form")
			var rows = content.rows;
			for (var i = 0; i < rows.length; i++) {
				var formRow = createFormRow(rows[i], content.columnWidth);
				formRow.classList.add(content.rowCss[i]);
				element.appendChild(formRow);
			}
		} else if (type === "Query") {
			element = document.getElementById("queryCaption");
			removeChildren(element);
			element.appendChild(document.createTextNode(content.caption));
			element = document.getElementById("query").cloneNode(true);
			var actions = content.actions;
			for (var i = 0; i < actions.length; i++) {
				var action = actions[i];
				var actionElement = document.createElement("div");
				createAction(actionElement, action);
				element.children[3].appendChild(actionElement);
			}
		} else if (type === "Login") {
			element = document.createElement("div");
			element.style = "height: 100%; display: flex; align-items: center; justify-content: center";
			var formAndActions = document.createElement("div");
			formAndActions.style = "width: 25em;";
			element.appendChild(formAndActions);
			var contentElement = createContent(content.content);
			formAndActions.appendChild(contentElement);
			var actions = content.actions;
			var footer = document.createElement("div");
			footer.style="float: right;"
			for (var i = 0; i < actions.length; i++) {
				var action = actions[i];
				var button = document.createElement("button");
				button.id = action.id;
				button.style="margin-right: 1em;"
				button.appendChild(document.createTextNode(action.name));
				button.setAttribute("onclick", "action(\"" + action.id + "\");");
				if (!action.enabled)
					button.setAttribute("disabled", "true");
				footer.appendChild(button);
			}
			formAndActions.appendChild(footer);
			addEnterAction(actions[content.loginActionIndex], contentElement, true);
		} else if (type === "Table") {
			element = document.createElement("table");
			element.name = content.id;
			element.classList.add("table");
			if (content.multiSelect) {
				element.classList.add("multiSelect");
			}
			var thead = document.createElement("thead");
			element.appendChild(thead);
			thead.appendChild(createTableColumns(content.headers, content.headerPathes, content.widths, content.maxWidths));
			element.appendChild(createTableColumnStyles(content.id, content.alignments));
			if (content.overview) {
				var tr = document.createElement("tr");
				thead.appendChild(tr);
				var th = document.createElement("th");
				th.setAttribute("colspan", content.headers.length);
				th.appendChild(createContent(content.overview));
				tr.appendChild(th);
			}
			thead.appendChild(createTableHeaders(content.id, content.headers, content.headerPathes, content.headerFilters));
			thead.appendChild(createTableFilters(content.id, content.headers, content.headerPathes, content.headerFilters, content.filterVisible));
			var tbody = document.createElement("tbody");
			element.appendChild(tbody);
			tbody.setAttribute("onclick", "tableSelection(event);");
			tbody.setAttribute("ondblclick", "tableAction(event);");
			tbody.setAttribute("onkeydown", "tableKeyHandler(event);");
			addTableRows(content.id, tbody, content.tableContent);
			var tfoot = document.createElement("tfoot");
			tfoot.columnCount = content.headers.length;
			element.appendChild(tfoot);
			addTableFooter(tfoot, content.paging);
		} else if (type === "Text" || type === "Title" || type === "Empty") {
			element = document.createElement("div");
			element.classList.add(type.toLowerCase());
			if (content.value) {
				element.innerHTML = escapeText(content.value);
			}
		} else if (type === "groupHorizontal" || type === "groupVertical") {
			element = document.createElement("div");
			element.classList.add(type);
			var components = content.components;
			for (var i = 0; i < components.length; i++) {
				var item = document.createElement("div");
				item.classList.add("groupItem");
				item.appendChild(createContent(components[i]));
				element.appendChild(item);
			}
		} else if (type === "Switch") {
			element = document.createElement("div");
			if (content.component != undefined) {
				element.appendChild(createContent(content.component));
			}
		} else if (type === "Action") {
			element = document.createElement("div");
			createAction(element, content);
		} else if (type === "TextField") {
			element = document.createElement("input");
			try {
				element.type = content.inputType;
				if (content.inputType === "time") {
					if (content.maxLength == 8) {
						element.step = 1;
					} else if (content.maxLength == 12) {
						element.step = "0.001";
					}
				}
			} catch (err) { // happens in ie 10 for datetime-local
				element.type = "text";
			}
			if (element.type === "text") {
				element.setAttribute("oninput", "ontextinput(this);");
				element.setAttribute("onblur", "setDeferredValue(this);");
				element.setAttribute("onchange", "ontextchange(this);");
			} else {
				element.setAttribute("onchange", "sendchange(this);");
			}
			element.setAttribute("maxlength", content.maxLength);
			if (content.value) {
				element.value = content.value;
			}
			if (content.autocomplete) {
				element.autocomplete = content.autocomplete;
			} else {
				element.autocomplete = "off";
			}
			if (content.placeholder) {
				element.setAttribute("placeholder", content.placeholder);
			}
			if (content.suggestions) {
				var datalist = document.createElement("datalist");
				datalist.id = content.id + "-list";
				element.appendChild(datalist);
				element.setAttribute("list", content.id + "-list");
				element.setAttribute("onkeyup", "loadSuggestions(event);");
			}
			element.changeOnFocus = content.changeOnFocus;
		} else if (type === "AreaField") {
			element = document.createElement("textarea");
			element.setAttribute("onkeyup", "sendchange(this);");
			element.setAttribute("maxlength", content.maxLength);
			if (content.value) {
				element.value = content.value;
			}
		} else if (type === "SearchTextField") {
			element = document.createElement("input");
			element.type = "text";
			element.id = content.id;
			element.setAttribute("style", "flex-grow: 1;");
			element.setAttribute("onkeydown", "if (event.keyCode == 13) sendchange(this);");
	
			var button = document.createElement("button");
			button.appendChild(document.createTextNode(content.textSearch));
			button.setAttribute("onclick", "sendchange(this.previousSibling);");
			button.setAttribute("style", "width: 10em;");
	
			var div = document.createElement("div");
			div.setAttribute("style", "display: flex;");
			div.appendChild(element);
			div.appendChild(button);
			return div; /* ! */
		} else if (type === "Combobox") {
			element = document.createElement("select");
			if (content.nullText != undefined) {
				var option = document.createElement("option");
				option.textContent = content.nullText;
				option.value = null;
				element.appendChild(option);
			}
			if (content.options) {
				for (var id in content.options) {
					var option = document.createElement("option");
					option.value = id;
					option.textContent = content.options[id].text;
					var description = content.options[id].description;
					if (description) option.title = description;
					element.appendChild(option);
				}
			}
			element.value = content.value;
			element.setAttribute("onchange", "sendchange(this);");
		} else if (type === "CheckBox") {
			element = document.createElement("input");
			element.type = "checkbox";
			element.setAttribute("onchange", "sendchange(this);");
			if (!editable) {
				element.setAttribute("disabled", "true");
			}
			element.id = content.id;
			if (content.value) {
				element.setAttribute("checked", "checked");
			}
			var label = document.createElement("label");
			label.className = "checkboxLabel";
			label.appendChild(element);
			label.appendChild(document.createTextNode(content.text));
			return label; /* ! */
		} else if (type === "RadioButtons") {
			element = document.createElement("fieldset");
			element.value = content.value;
			for (var id in content.options) {
				var button = document.createElement("input");
				button.type = "radio";
				button.value = id;
				button.id = id;
				button.name = content.id + "-name";
				if (element.value == button.id) {
				 	button.setAttribute("checked", "checked");
				 }
				button.setAttribute("onchange", "sendchange(this);");
				element.appendChild(button);
				var label = document.createElement("label");
				label.setAttribute("for", id);
				label.appendChild(document.createTextNode(content.options[id].text));
				var description = content.options[id].description;
				if (description) label.title = description;
				element.appendChild(label);
			}
		} else if (type === "Lookup") {
			element = document.createElement("div");
			element.className = "lookup";
			element.appendChild(createContent(content.input));
			var button = document.createElement("div");
			button.className = "lookupButton";
			button.setAttribute("onclick", "openLookupDialog(\"" + content.id + "\");");
			element.appendChild(button);
		} else if (type === "LookupActions") {
			element = document.createElement("div");
			element.className = "lookup";
			element.appendChild(createContent(content.input));
			var actionElement = document.createElement("div");
			actionElement.className = "dropdownButton";
			element.appendChild(actionElement);
			var dropdownElement = document.createElement("div");
			dropdownElement.className = "dropdown";
			dropdownElement.style.display = "none";
			element.appendChild(dropdownElement);
			actionElement.onclick = function(e) {
				var isOpen = dropdownElement.style.display == "block"; 
				closeActionMenu();
				if (!isOpen) {
					dropdownElement.style.display = "block";
					var actionElementRect = actionElement.getBoundingClientRect();
					dropdownElement.style.right = document.body.getBoundingClientRect().right - actionElementRect.right;
					dropdownElement.style.top = actionElementRect.bottom + 2;			
				}
				e.stopPropagation();
			}
			for (var i = 0; i < content.actions.length; i++) {
				var a = content.actions[i];
				var item = document.createElement("div");
				item.innerHTML = escapeText(a.name);
				item.setAttribute("onclick", "action(\"" + a.id + "\");");
				dropdownElement.appendChild(item);
			}
		} else if (type === "List") {
			element = document.createElement("div");
			element.id = content.id;
			for (var i = 0; i < content.length; i++) {
				var item = createContent(content[i]);
				element.appendChild(item);
			}
			element.className = "list";
			var enabled = content.enabled == undefined || content.enabled;
			element.style.display = enabled ? "block" : "none";
			return element;
		} else if (type === "Url") {
			element = document.createElement("iframe");
			element.src = content.htmlOrUrl;
			element.height = "50%"; // cross origin doesn't allow to get childs height
		} else if (type === "Html") {
			// this is not used at the moment as IE (before chrome) doesn't support it
			element = document.createElement("iframe");
			element.srcdoc = content.htmlOrUrl;
		} else if (type === "Image") {
			if (editable) {
				element = document.createElement("input");
				element.type = "file";
				element.setAttribute("onchange", "sendchange(this);");
			} else {
				element = document.createElement("img");
				if (content.value) {
					element.src = "data:image;base64, " + content.value;
				}
				if (content.maxHeight) {
					element.style.maxHeight = (content.maxHeight * 5 - 3) + "em";
				}
			}
		} else {
			element = document.createElement("div");
			element.appendChild(document.createTextNode("unknown: " + type));
		}
		if (!editable) {
			element.setAttribute("disabled", "true");
		}
		if (content.id) {
			element.id = content.id;
		}
		if (content.cssClass) {
			element.classList.add(content.cssClass);
		}
		if (content.validationMessage != undefined && content.validationMessage.length > 0) {
			element.title = content.validationMessage;
		}
		return element;
	}
	
	function createFormRow(row, columnWidth) {
		var element = document.createElement("div");
		for (var i = 0; i < row.length; i++) {
			var span = row[i].span;
			span = span ? span : 1;
			var cellElement = createFormCell(row[i], span, columnWidth);
			element.appendChild(cellElement);
		}
		return element;
	}
	
	function createFormCell(cell, span, width) {
		var cellContent = createContent(cell);
		
		var cellElement = document.createElement("div");
		cellElement.classList.add("formElement");
		cellElement.id = cell.id + "-element";
		if (cell.hideFormElement) {
			cellElement.classList.add("hideFormElement");
		}
		cellElement.appendChild(cellContent);
		setWidths(cellElement, cellContent, span, width);

		var isTitle = cell.type === "Title";
		if (isTitle) {
			cellElement.style.display = "flex";
			return cellElement;
		}
		
		if (cell.caption) {
			var caption = document.createElement("label");
			caption.setAttribute("for", cell.firstId ? cell.firstId : cell.id);
			if (cellContent.hasAttribute("disabled")) {
				caption.setAttribute("disabled", "true");
			}
			caption.appendChild(document.createTextNode(cell.caption));

			if (cell.required) {
				var asterisk = document.createElement("span");
				asterisk.appendChild(document.createTextNode("*"));
				asterisk.className = "asterisk";
				caption.appendChild(asterisk);			
			}			
			
			cellElement.insertBefore(caption, cellContent);
		}
			
		return cellElement;
	}
	
	function setWidths(cellElement, cellContent, span, width) {
		cellElement.style.width = (width * span / 8 + (span - 1) * 0.7) + "rem";
		cellElement.style.flexGrow = span;
	}

	function createTableColumns(headers, headerNames, widths, maxWidths) {
		var element = document.createElement("tr");
		for (var i = 0; i < headers.length; i++) {
			var th = document.createElement("th");
			th.className = "col " + headerNames[i];
			th.setAttribute("width", widths[i]);
			th.style.maxWidth = maxWidths[i];			
			element.appendChild(th);
		}
		return element;
	}
	
	function createTableColumnStyles(elementId, alignments) {
		var tableStyle = document.createElement("style");
		tableStyle.type = "text/css";
		var style = "";
		for (var i = 0; i < alignments.length; i++) {
			if (alignments[i] != undefined) {
				var columnStyle = "text-align: " + alignments[i] + ";";
				if (alignments[i] == "end") {
					columnStyle = columnStyle + "padding-right: 1em;"
				}
				style = style + "#" + CSS.escape(elementId) + " td:nth-child(" + (i+1) + ") {" + columnStyle + "}\n";
			}
		}
		tableStyle.appendChild(document.createTextNode(style));
		return tableStyle;
	}
	
	function createTableHeaders(tableId, headers, headerNames, headerFilters) {
		var element = document.createElement("tr");
		element.className = "headers"; 
		for (var i = 0; i < headers.length; i++) {
			var th = document.createElement("th");
			th.appendChild(document.createTextNode(headers[i]));
			th.setAttribute("onclick", "tableSortAction(\"" + tableId + "\", " + i + " );");
			element.appendChild(th);
		}
		return element;
	}

	function createTableFilters(tableId, headers, headerNames, headerFilterLookups, filterVisible) {
		var element = document.createElement("tr");
		element.classList.add("columnFilters");
		if (!filterVisible) {
			element.classList.add("hide");
		}		
		for (var i = 0; i < headers.length; i++) {
			var th = document.createElement("th");
			th.classList.add("formElement");
			th.classList.add("columnFilter");
			th.classList.add(headerNames[i]);
			
			var input = createContent(headerFilterLookups[i]);
			th.appendChild(input);
			th.id = headerFilterLookups[i].id + "-element";
			
			element.appendChild(th);
		}
		return element;
	}

	function addTableRows(tableId, tbodyElement, rows) {
		for (var i = 0; i < rows.length; i++) {
			var rowElement = createTableRow(tableId, i, rows[i]);
			tbodyElement.appendChild(rowElement);
		}
	}
	
	function createTableRow(tableId, rowIndex, row) {
		var element = document.createElement("tr");
		for (var i = 0; i < row.length; i++) {
			element.appendChild(createTableCell(tableId, rowIndex, i, row[i]));
		}
		return element;
	}
	
	function createTableCell(tableId, rowIndex, columnIndex, cell) {
		var td = document.createElement("td");
		if (cell) {
			if (cell.action) {
				td.appendChild(document.createTextNode(cell.action));
				td.className = "action";
				td.setAttribute("onclick", "cellAction(\"" + tableId + "\", " + rowIndex + ", " + columnIndex + ");");
			} else if (cell.color) {
				td.appendChild(document.createTextNode(cell.value));
				td.classList.add(cell.color);
			} else {
				td.appendChild(document.createTextNode(cell));
			}
		}
		return td;
	}
	
	function addTableFooter(tableFooterElement, content) {
		if (content) {
			var tr = document.createElement("tr");
			tableFooterElement.appendChild(tr);
			var td = document.createElement("td");
			td.setAttribute("colspan", tableFooterElement.columnCount);
			td.style = "text-align: center; padding: 1em;";
			document.getElementById("tableFooterButtons").childNodes.forEach(function(item) {
		    	td.appendChild(item.cloneNode(true));
			});
			td.querySelector(".currentPage").innerHTML = content;
			tr.appendChild(td);
		}
	}
	
	function createAction(element, config) {
		element.className = "action";
		element.textContent = config.name;
		if (config.description) element.setAttribute("title", config.description);
		element.setAttribute("onclick", "action(\"" + config.id + "\");");
	}
	
	function removeChildren(element) {
		while (element.firstChild) {
			element.removeChild(element.firstChild);
		}
	}
	
	function updateNavigation(menus) {
		var navigationElement = document.getElementById("navigation");
		removeChildren(navigationElement);
	
		var menuElement = createMenu(menus);
		menuElement.style.marginTop = "0px";
		navigationElement.appendChild(menuElement);
	}
	
	function createMenu(items) {
		var ul = document.createElement("ul");
	
		for (var i = 0; i < items.length; i++) {
			var item = items[i];
			var li = document.createElement("li");
			ul.appendChild(li);
			if (item.name) {
				if (item.items) {
					li.appendChild(document.createTextNode(item.name));
					li.appendChild(createMenu(item.items));
				} else if (item.id) {
					var a = document.createElement("a");
					a.setAttribute("onclick", "action(\"" + item.id + "\"); return false;");
					a.setAttribute("href", item.link != undefined ? item.link : ".");
					if (!item.enabled) {
						a.setAttribute("disabled", "true");
					}
					a.id = item.id;
					a.classList.add("action");
					a.appendChild(document.createTextNode(item.name));
					li.appendChild(a);
				}
			} else {
				li.appendChild(document.createElement("hr"));
			}
		}
		return ul;
	}
	
	function toggleNavigation(openOrClose) {
		var navigationElement = document.getElementById("navigationContainer");
		var isClosed = navigationElement.style.display === "none";
		if (isClosed && (openOrClose == undefined || openOrClose === "open")) {
			navigationElement.style.display = "block";
			closeActionMenu();
		} else if (!isClosed && (openOrClose == undefined || openOrClose == "close")) {
			navigationElement.style.display = "none";
		}
	}
	
	function showDialog(json) {
		var dialog = document.createElement("dialog");
		dialog.id = json.id;
		if (json.className != "") {
			dialog.classList.add(json.className);
		}
	
		var block = document.createElement("div");
		block.classList.add("is-blocked");
		dialog.appendChild(block);
	
		var header = document.createElement("div");
		header.classList.add("dialogHeader");
		var headerText = document.createElement("span");
		headerText.appendChild(document.createTextNode(json.title));
		header.appendChild(headerText);
		var buttons = document.getElementById("dialogButtonsTemplate").cloneNode(true);
		while (buttons.children.length> 0) header.appendChild(buttons.children[0]);
		dialog.appendChild(header);
	
		var content = createContent(json["content"]);
		if (content.tagName.toUpperCase() == "TABLE") {
			var wrapper = document.createElement("div");
			wrapper.classList.add("dialogContentWrapper");
			wrapper.appendChild(content);
			content = wrapper;
		}
		content.classList.add("dialogContent");
		dialog.appendChild(content);
	
		var actions = json["actions"];
		if (actions) {
			var footer = document.createElement("div");
			footer.classList.add("dialogFooter");
			for (var i = 0; i < actions.length; i++) {
				var action = actions[i];
				var button = document.createElement("button");
				button.id = action.id;
				button.appendChild(document.createTextNode(action.name));
				if (action.form) {
					button.setAttribute("onclick", "action(\"" + action.id + "\", \"" + action.form + "\");");
				} else {
					button.setAttribute("onclick", "action(\"" + action.id + "\");");
				}
				if (!action.enabled)
					button.setAttribute("disabled", "true");
				footer.appendChild(button);
			}
			dialog.appendChild(footer);
		}
		
		var resize = document.getElementById("dialogResizeTemplate").cloneNode(true);
		dialog.appendChild(resize);
	
		addEnterAction(json.saveAction, content);

		var parent = document.getElementById("body");
		parent.appendChild(dialog);
		if (dialog.show == undefined) {
			dialogPolyfill.registerDialog(dialog);
		}
	
		if (json.closeAction != undefined) {
		    dialog.closeAction = json.closeAction;
			dialog.addEventListener("cancel", closeDialogButton);
		}
		dialog.addEventListener("close", dialogClosedListener);

		dialog.showModal();

		if (window.innerWidth < 600) {
			dialog.classList.add("fullscreen");
		} else {
			var computedStyle = window.getComputedStyle(dialog);
	
			var initialWidth = json.width;
			if (initialWidth <= 0) {
				initialWidth = parseInt(computedStyle.width, 10);
			}
			dialog.style.width = Math.min(initialWidth, window.innerWidth - 200);
			dialog.style.left = Math.max((window.innerWidth - initialWidth) / 3 , 0);

			var intialHeight = json.height;
			if (intialHeight <= 0) {
				// plus 1 or firefox in uhd and material-design will scroll
				var intialHeight = parseInt(computedStyle.height, 10) + 1;
			}
			dialog.style.height = Math.min(intialHeight, window.innerHeight - 40);

			header.addEventListener("mousedown", addMoveListener);
			header.addEventListener("dblclick", dialogClickListener);
		}
	}

	function addEnterAction(enterAction, form, isLogin) {
		var inputs = form.getElementsByTagName("input");
		for (var i = 0; i < inputs.length; i++) {
			inputs[i].onkeydown = function(event) {
				if (event.keyCode === 13) focusNext(event, form, enterAction, isLogin);
			}
		}
	}
	
	function focusNext(event, form, enterAction, isLogin) {
		var inputs = form.querySelectorAll('input, select, textarea');
		var i = 0;
		while (inputs[i] != event.target && i < inputs.length - 1) {
			i++;
		}
		var next = i + 1;
		while (next < inputs.length && (inputs[next].disabled || isLogin && inputs[next].type == "checkbox")) {
			next++;
		}
		if (next < inputs.length) {
			inputs[next].focus();			
		} else if (enterAction != undefined) {
			var button = document.getElementById(enterAction.id);
			if (button.getAttribute("disabled") == undefined) {
				if (timerTextFieldChange) {
					clearTimeout(timerTextFieldChange);
					timerTextFieldChange = null;
				}
				sendchange(event.target, enterAction.id);
			}
		}
	}	
	
	function closeDialogButton(event) {
		var dialog = event.target;
		while (dialog.tagName.toUpperCase() != "DIALOG" && (dialog = dialog.parentNode));
		if (dialog.closeAction != undefined) {
			action(dialog.closeAction.id);		
			event.preventDefault();
		} else {
			dialog.close();
		}
	}

	function dialogClosedListener(event) {
		document.getElementById("body").removeChild(event.target);
	}
	
	function closeDialogs() {
		var dialogs = document.getElementsByTagName("dialog");
		if (dialogs) {
			for (var i = 0; i < dialogs.length; i++) {
				var dialog = dialogs[i];
				document.getElementById("body").removeChild(dialog);
			}
		}
	}
	
	var dialogElement;
	
	function startDialogDrag(event) {
		dialogElement = event.target;
		while (dialogElement.tagName.toLowerCase() != "dialog") dialogElement = dialogElement.parentElement;
		if (event.buttons == 1 && !dialogElement.classList.contains("fullscreen")) {
			event.preventDefault();
		} else {
			dialogElement = null;
		}
	}
	
	function addMoveListener(event) {
		startDialogDrag(event);
		if (dialogElement != null) {
			window.addEventListener("mousemove", dialogMoveListener);
		}
	}

	function dialogMoveListener(event) {
		if (event.buttons != 1) {
			window.removeEventListener("mousemove", dialogMoveListener);
		} else {			
			var style = window.getComputedStyle(dialogElement);
			var left = parseInt(style.left, 10) + event.movementX;
			var top = parseInt(style.top, 10) + event.movementY;
			dialogElement.style.left = Math.max(0, Math.min(left, window.innerWidth - 80)) + 'px';
			dialogElement.style.top = Math.max(0, Math.min(top, window.innerHeight - 40)) + 'px';
		}
	}

	function addResizeListener(event) {
		startDialogDrag(event);
		if (dialogElement != null) {
			window.addEventListener("mousemove", dialogResizeListener);
		}
	}
	
	function dialogResizeListener(event) {
		if (event.buttons != 1) {
			window.removeEventListener("mousemove", dialogResizeListener);
		} else {			
			var style = window.getComputedStyle(dialogElement);
			var width = parseInt(style.width, 10) + event.movementX;
			var height = parseInt(style.height, 10) + event.movementY;
	
			dialogElement.style.width = Math.max(350, width);
			dialogElement.style.height = Math.max(150, height);
			
			event.preventDefault();
		}
	}

	function dialogClickListener(event) {
		var dialogElement = event.target;
		while (dialogElement.tagName.toLowerCase() != "dialog") dialogElement = dialogElement.parentElement;
		dialogElement.classList.toggle("fullscreen");
	}
	
	function sendchange(source, saveAction) {
		source.classList.add("changed");
		var data = {};
		var changedValue = {};
		if (source.type == "checkbox") {
			/* for checkboxes value is always true */
			changedValue[source.id] = source.checked;
		} else if (source.type == "radio") {
			changedValue[source.name.substring(0, source.name.length - 5)] = source.id;
		} else if (source.type == "password") {
			changedValue[source.id] = source.value.split("");
		} else if (source.type == "file") {
			var reader = new FileReader();
			reader.onload = function(e) {
				var binary = "";
				var bytes = new Uint8Array(reader.result);
				for (var i = 0; i < bytes.byteLength; i++) {
					binary += String.fromCharCode(bytes[i]);
				}
				changedValue[source.id] = btoa(binary);
				data.changedValue = changedValue;
				send(data, false);
			}
			reader.readAsArrayBuffer(source.files[0]); // readAsBinaryString would be shorter but not supported on IE
			return;
		} else {
			changedValue[source.id] = source.value;
		}
		data.changedValue = changedValue;
		if (saveAction) {
			data.activatedAction = saveAction;
			send(data, true);
		} else {
			send(data, false);
		}
	}

	function loadSuggestions(event) {
		var source = event.target;
		if (event.keyCode == 13) {
			source.currentSuggestions = source.value;
			return;
		}
		var currentSuggestions = source.currentSuggestions;
		if (currentSuggestions == undefined || currentSuggestions != source.value) {
			source.currentSuggestions = source.value;
			var data = {
				"loadSuggestions": source.id,
				"searchText": source.value
			};
			send(data, false);
		}
	}
	
	function createSuggestions(id, suggestions) {
		var datalist = document.getElementById(id + "-list");
		removeChildren(datalist);
		for (var i = 0; i < suggestions.length; i++) {
			var option = document.createElement("option");
			option.setAttribute("value", suggestions[i]);
			datalist.appendChild(option);
		}
	}

	function logout() {
		send({"logout": "logout"}, true);
	}

	function login() {
		send({"login": "login"}, true);
	}

	function action(actionId, formId) {
		if (formId) {
			var formElement = document.getElementById(formId);
			formElement.classList.add("showValidations");
		}
		closeActionMenu();
		var data = {
			"activatedAction": actionId
		};
		send(data, true);
	}
	
	function cellAction(tableId, row, column) {
		closeActionMenu();
		
		var data = {
			"cellAction": {
				"table": tableId, "row": row, "column": column
			}
		};
		send(data, true);
	}
	
	var lastSelectedTable;
	var lastSelectedRow;
	
	function tableKeyHandler(event) {
		if (event.keyCode == 13) {
			var rowElement = event.target;
			if (rowElement.classList.contains("selected")) {
				tableAction(event);
			} else {
				tableSelection(event);
			}
		}
	}
	
	function tableSelection(event) {
		if (event.type === "contextmenu") {
			return;
		}	
		var rowElement = event.target.tagName == "TD" ? event.target.parentElement : event.target;
		var tbodyElement = rowElement.parentElement;
		var tableElement = tbodyElement.parentElement;
	
		var pageElement = tableElement;
		while ((pageElement = pageElement.parentNode) && pageElement.className != "page");
	
		var headerRowCount = tableElement.tHead.childNodes.length;
		var row = rowElement.rowIndex - headerRowCount;
		var multiSelect = tableElement.classList.contains("multiSelect");
		var rows = [];
		if (multiSelect && lastSelectedTable == tableElement && event.shiftKey) {
			for (var i = 0; i < tbodyElement.rows.length; i++) {
				if (i < row && i < lastSelectedRow || i > row && i > lastSelectedRow) {
					tbodyElement.rows[i].classList.remove("selected");
				} else if (i >= row && i <= lastSelectedRow || i >= lastSelectedRow && i <= row) {
					rows.push(i);
					tbodyElement.rows[i].classList.add("selected");
				}
			}
		} else {
			if (!(multiSelect && event.ctrlKey)) {
				for (var i = 0; i < tbodyElement.rows.length; i++) {
					tbodyElement.rows[i].classList.remove("selected");
				}
			}
			tbodyElement.rows[row].classList.add("selected");
			for (var i = 0; i < tbodyElement.rows.length; i++) {
				if (tbodyElement.rows[i].classList.contains("selected")) {
					rows.push(i);
				}
			}
		}
		lastSelectedTable = tableElement;
		lastSelectedRow = row;
	
		var tableAction = {
			"table": tableElement.id,
			"rows": rows
		};
		var data = {
			"tableSelection": tableAction
		};
		send(data, false);
	}
	
	function tableAction(event) {
		var rowElement = event.target.tagName == "TD" ? event.target.parentElement : event.target;
		var tbodyElement = rowElement.parentElement;
		var tableElement = tbodyElement.parentElement;
		
		var headerRowCount = tableElement.tHead.childNodes.length;
		var tableAction = {
			"table": tableElement.id,
			"row": rowElement.rowIndex - headerRowCount
		};
		var data = {
			"tableAction": tableAction
		};
		send(data, true);
	
		event.preventDefault();
		window.getSelection().empty(); // avoid ... menu in Chrome
	}

	
	function tableSortAction(tableId, column) {
		var tableAction = {
			"table": tableId,
			"column": column
		};
		var data = {
			"tableSortAction": tableAction
		};
		send(data, true);
	}
	
	function tableFilterEditor(tableId, column) {
		var tableAction = {
			"table": tableId,
			"column": column
		};
		var data = {
			"tableFilterEditor": tableAction
		};
		send(data, true);
	}
		
	function openLookupDialog(lookup) {
		send({
			"openLookupDialog": lookup
		}, true);
	}
	
	function search() {
		var searchElement = document.getElementById("search");
		var search = searchElement.value;
		if (search && search.length > 0) {
			var data = {
				"search": search
			};
			send(data, true);
		} else {
			searchElement.style.display = "none";
		}
	}
	
	function querySearch() {
		var searchElement = document.getElementById("querySearch");
		var data = { "search": searchElement.value };
		send(data, true);
	}
	
	function searchButtonAction() {
		var searchElement = document.getElementById("search");
		if (searchElement.style.display == "inline") {
			searchElement.style.display = "none";
			searchElement.value = "";
		} else {
			searchElement.style.display = "inline";
			searchElement.focus();
		}
	}
	
	function send(data, block) {
		if (isUiBlocked()) {
			return;
		}
		if (block) {
			blockUi();
		}
	
		data.inputTypes = isMobile && checkInput("date");

		var dialogElements = document.getElementsByTagName("dialog");
		data.dialogVisible = dialogElements && dialogElements.length > 0;
	
		send0(data);
	}

	function send0(data) {
		data.session = session;
		$SEND(data);
	}
	
	function isUiBlocked() {
		return blockStyle.parentNode != undefined;
	}
	
	function blockUi() {
		document.body.appendChild(blockStyle);
	}
	
	function unblockUi() {
		if (isUiBlocked()) {
			blockStyle.parentNode.removeChild(blockStyle);
		}
	}
	
	var heartbeatTimer;
	
	function sendAjax(data) {
		if (heartbeatTimer) {
			clearInterval(heartbeatTimer);
		}
		heartbeatTimer = setInterval(heartbeat, 15 * 1000);
	
		var xmlhttp = new XMLHttpRequest();
		xmlhttp.open("POST", "ajax_request.json", true);
        xmlhttp.overrideMimeType('application/json');
	
		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState === 4) {
				pendingRequests--;			
				if (xmlhttp.status === 200) {
					onMessage(xmlhttp.responseText);
				}
			}
		}
		pendingRequests++;
		xmlhttp.send(JSON.stringify(data));
	}
	
	function heartbeat() {
		if (!isUiBlocked()) {
			send0({});
		}
	}
	
	function sendWebSocket(data) {
		if (websocket == null || websocket.readyState > 1) {
			var pathname = location.pathname;
			var index = pathname.lastIndexOf("/");
			pathname = pathname.substring(0, index + 1);
	
			var wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
			var hostAndPort = location.host + "$PORT";
			var socketUrl = wsProtocol + "://" + hostAndPort + pathname + "$WS";
			websocket = new WebSocket(socketUrl);
			websocket.onmessage = function(evt) {
				pendingRequests--;
				onMessage(evt.data)
			};
			websocket.onopen = function(evt) {
				send(data);
			}
		} else {
			pendingRequests++;
			websocket.send(JSON.stringify(data));
		}
	}
	
	function sendCheerpj(data) {
		var sendStr = JSON.stringify(data);
		console.log("send");
		console.log(sendStr);
		cjCall("org.minimalj.frontend.impl.cheerpj.Cheerpj", "receiveMessage", sendStr).then(receive);
	}
	
	function receive(e) {
		var resultStr = cjStringJavaToJs(e);
		console.log("receive");
		console.log(resultStr);
		onMessage(resultStr);
	}
	
	function resizeDialogs(event) {
		var dialogs = document.getElementsByTagName("dialog");
		if (dialogs && dialogs.length > 0) {
			for (var i = 0; i < dialogs.length; i++) {
				var dialog = dialogs[i];
				var computedStyle = window.getComputedStyle(dialog);
				var left = parseInt(computedStyle.left)
				if (left > window.innerWidth - 80) {
					dialog.style.left = window.innerWidth - 80;
				}
				var top = parseInt(computedStyle.top);
				if (top > window.innerHeight - 40) {
					dialog.style.top = window.innerHeight - 40;
				}
			}
		}
	}
	
	var lastWidth = 10000;
	
	function resizeNavigation() {
		var newWidth = window.innerWidth;
		if (lastWidth > newWidth && newWidth < 800) {
			toggleNavigation("close");
			// document.getElementById("search").style.display = "none";      
		} else if (lastWidth < newWidth && newWidth >= 1200) {
			toggleNavigation("open");
		}
		lastWidth = newWidth;
		
		var pageContentAndActionElements = document.getElementsByClassName("pageContentAndActions");
	    for (var i = 0; i < pageContentAndActionElements.length; i++) {
	    	var pageContentAndActionElement = pageContentAndActionElements[i];
	    	var actionSideBarElement = pageContentAndActionElement.querySelector(".actionSideBar");
	    	if (actionSideBarElement != null) {
		    	var pageContentElement = pageContentAndActionElement.querySelector(".pageContent");
	
		    	var computedStyle = window.getComputedStyle(actionSideBarElement);
				var actionSideBarWidth = parseInt(computedStyle.width, 10);
				
				actionSideBarElement.classList.add("hide"); // first hide to get width correct
				computedStyle = window.getComputedStyle(pageContentElement.childNodes[0]);
				var pageContentMaxWidth = parseInt(computedStyle.width, 10);
				
		    	if ((pageContentAndActionElement.offsetWidth - actionSideBarWidth) > pageContentMaxWidth) {
		    		actionSideBarElement.classList.remove("hide");
		    	}
	    	}
	    }
	}
	
	function changeLogin() {
		send({
			"login": "login-" + (new Date().getTime())
		}, true);
	}
	
	function init(e) {
		init();
	}
	
	function init() {
		pageContainerElement = document.getElementById("pageContainer");
		titleElement = document.getElementsByTagName("title")[0];
	
		if (window.innerWidth >= 992) toggleNavigation("open");
	
		window.addEventListener("resize", resizeNavigation);
		window.addEventListener("resize", resizeDialogs);
		window.addEventListener("resize", closeActionMenu);
		window.addEventListener("click", closeActionMenu);
		window.addEventListener("scroll", closeActionMenu, true); // true -> capture the event on dispatch, even if that event does not normally bubble
		window.addEventListener("mousewheel", closeActionMenu);
		window.addEventListener("blur", closeActionMenu);
		document.onkeydown = function(e) {
			if (e.keyCode === 27) {
				closeActionMenu();
			}
		};
	
		window.onpopstate = popState;
	
		var initParameters = {};
		initParameters.initialize = window.history.state ? window.history.state : "$PATH";
		if (localStorage.rememberMeToken != undefined) initParameters.rememberMeToken = localStorage.rememberMeToken;
		send(initParameters, true);
	}
	
	function checkInput(type) {
		var input = document.createElement("input");
		input.setAttribute("type", type);
		return input.type == type;
	}
	
	function escapeText(s) {
		return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;").replace(/\n/g, "<br>");
	}
	
	$INIT
</script>
<meta name="viewport" content="width=device-width" />
</head>
<body onload="init();" id="body" class="no-contrast">
	<div id="header" class="hidden-print">
		<svg id="navigationToggle" class="button headerButton" style="margin-left: 1.0em;" onclick="toggleNavigation()">
              <g style="stroke-width:0px"> 		
  				<title>Show or hide navigation</title>
				<rect x="0" y="5%" width="100%" height="0.25em"/>
				<rect x="0" y="40%" width="100%" height="0.25em"/>
				<rect x="0" y="75%" width="100%" height="0.25em"/>
			</g>
		</svg>
		<svg id="logout" class="button headerButton" style="margin-left: 1.0em; display: none;" onclick="logout()">
              <g style="stroke-width:13%;stroke-linecap:square"> 		
  				<title>Logout</title>
				<line x1="5%" y1="5%" x2="50%" y2="5%" />
				<line x1="5%" y1="5%" x2="5%" y2="95%" />
				<line x1="5%" y1="95%" x2="50%" y2="95%" />
				<line x1="40%" y1="50%" x2="95%" y2="50%" />
				<line x1="75%" y1="30%" x2="95%" y2="50%" />
				<line x1="75%" y1="70%" x2="95%" y2="50%" />
			</g>
		</svg>		
		<svg id="login" class="button headerButton" style="margin-left: 1.0em; display: none;" onclick="login()">
              <g style="stroke-width:13%;stroke-linecap:square"> 		
  				<title>Logout</title>
				<line x1="95%" y1="5%" x2="50%" y2="5%" />
				<line x1="95%" y1="5%" x2="95%" y2="95%" />
				<line x1="95%" y1="95%" x2="50%" y2="95%" />
				<line x1="5%" y1="50%" x2="60%" y2="50%" />
				<line x1="40%" y1="30%" x2="60%" y2="50%" />
				<line x1="40%" y1="70%" x2="60%" y2="50%" />
			</g>
		</svg>		
		<svg id="wait" class="button headerButton" style="width: 0em;">
			<g style="stroke-width:3px;stroke-linecap:square"> 	
				<line x1="6%" y1="93%" x2="93%" y2="93%" />
			</g>
		</svg>
		<span id="pageTitle" style="padding-left: 1em; padding-bottom: 0.5em;"></span>
		<div id="searchSpan">
			<input type="search" id="search" onkeydown="if (event.keyCode == 13) search();" />
			<svg id="searchButton" class="button headerButton" onclick="searchButtonAction();">
				<g style="stroke-width:16%;stroke-linecap:square"> 		
					<line x1="59%" y1="59%" x2="91%" y2="91%" />
					<circle cx="37%" cy="37%" r="30%" stroke-width="14%" fill="none" />
				</g>
			</svg>
			<svg id="tableFilterButton" style="stroke-width:0px" class="filterButton headerButton button hide hidden-print" onclick="toggleFilter(evt);">
				<line x1="7%" y1="12%" x2="50%" y2="57%" style="stroke-width:10%" />
				<line x1="93%" y1="12%" x2="50%" y2="57%" style="stroke-width:10%" />
				<line x1="7%" y1="12%" x2="93%" y2="12%" style="stroke-width:10%" />
				<line x1="50%" y1="57%" x2="50%" y2="93%" style="stroke-width:15%" />
			</svg>
			<svg id="sideBarActionButton" class="button headerButton" onclick="toggleActionSideBar(evt);">
				<g style="stroke-width:0px"> 		
					<rect x="35%" y="13%" width="30%" height="17%"/>
					<rect x="35%" y="46%" width="30%" height="17%"/>
					<rect x="35%" y="80%" width="30%" height="17%"/>
				</g>
			</svg>
		</div>			
	</div>
	<div id="container">
		<div id="navigationContainer" style="display: none;" class="hidden-print">
			<div id="navigationHeader" class="secondHeader">
				<svg id="closeNavigation" class="pageButton button secondHeaderButtons" onclick="toggleNavigation()">
				  <line x1="7%" y1="7%" x2="93%" y2="93%" style="stroke-width:20%" />
				  <line x1="7%" y1="93%" x2="93%" y2="7%" style="stroke-width:20%" />
				</svg>
			</div>
			<div id="navigation">
			</div>
		</div>
		<noscript style="display: block; margin: 2em;">$NOSCRIPT</noscript>
		<div id="pageContainer" onContextmenu="showContextMenu(event);">
		</div>	
	</div>
	<div id="applicationVersion" class="hidden-print">$APPLICATION-VERSION</div>

	<div id="templates" style="display: none">
		<div id="tablePageHeaderButtons">
			<svg style="stroke-width:0px" class="filterButton pageButton button hidden-print" onclick="toggleFilter(evt);">
				<line x1="7%" y1="12%" x2="50%" y2="57%" style="stroke-width:15%" />
				<line x1="93%" y1="12%" x2="50%" y2="57%" style="stroke-width:15%" />
				<line x1="7%" y1="12%" x2="93%" y2="12%" style="stroke-width:15%" />
				<line x1="50%" y1="57%" x2="50%" y2="93%" style="stroke-width:20%" />
			</svg>
			<svg style="stroke-width:0px" class="downloadButton pageButton button hidden-print">
				<line x1="50%" y1="10%" x2="50%" y2="95%" style="stroke-width:15%" />
				<line x1="22%" y1="55%" x2="50%" y2="95%" style="stroke-width:15%" />
				<line x1="78%" y1="55%" x2="50%" y2="95%" style="stroke-width:15%" />
				<a href="download">
					<rect x="0" y="0" width="100%" height="100" style="fill:transparent"/>
				</a>
			</svg>
		</div>
		<div id="tableFooterButtons">
			<svg style="stroke-width:0px" class="prevButton pageButton button tablePageing hidden-print" onclick="tablePage(evt, 'first');">
				<line x1="20%" y1="15%" x2="20%" y2="85%" style="stroke-width:15%" />
				<line x1="80%" y1="20%" x2="40%" y2="50%" style="stroke-width:15%" />
				<line x1="80%" y1="80%" x2="40%" y2="50%" style="stroke-width:15%" />
			</svg>
			<svg style="stroke-width:0px" class="prevButton pageButton button tablePageing hidden-print" onclick="tablePage(evt, 'prev');">
				<line x1="60%" y1="20%" x2="20%" y2="50%" style="stroke-width:15%" />
				<line x1="60%" y1="80%" x2="20%" y2="50%" style="stroke-width:15%" />
			</svg>
			<span class="currentPage tablePageing hidden-print">-</span>
			<svg style="stroke-width:0px" class="nextButton pageButton button tablePageing hidden-print" onclick="tablePage(evt, 'next');">
				<line x1="20%" y1="20%" x2="60%" y2="50%" style="stroke-width:15%" />
				<line x1="20%" y1="80%" x2="60%" y2="50%" style="stroke-width:15%" />
			</svg>
			<svg style="stroke-width:0px" class="prevButton pageButton button tablePageing hidden-print" onclick="tablePage(evt, 'last');">
				<line x1="20%" y1="20%" x2="60%" y2="50%" style="stroke-width:15%" />
				<line x1="20%" y1="80%" x2="60%" y2="50%" style="stroke-width:15%" />
				<line x1="80%" y1="15%" x2="80%" y2="85%" style="stroke-width:15%" />
			</svg>
		</div>		
		<div id="pageHeaderButtons">
			<svg style="stroke-width:0px" class="sideBarActionButton pageButton button hidden-print" onclick="toggleActionSideBar(evt);">
				<rect x="30%" y="13%" width="40%" height="17%"/>
				<rect x="30%" y="46%" width="40%" height="17%"/>
				<rect x="30%" y="80%" width="40%" height="17%"/>
			</svg>
			<svg class="pageButton button toggleButton hidden-print" onclick="togglePage(evt);">
			  <rect x="20%" y="80%" width="80%" height="13%" />
			</svg>
			<svg class="pageButton button closeButton hidden-print" onclick="closePage(evt);">
				<line x1="7%" y1="7%" x2="93%" y2="93%" style="stroke-width:20%" />
				<line x1="7%" y1="93%" x2="93%" y2="7%" style="stroke-width:20%" />
			</svg>
		</div>
		<div id="dialogButtonsTemplate" class="dialogButtons">
			<svg class="pageButton button maximizeButton" onclick="dialogClickListener(evt)">
			  <rect x="22%" y="22%" width="56%" height="56%" stroke-width="12%" fill="none" />
			</svg>
			<svg class="pageButton button" onclick="closeDialogButton(evt)">
			  <line x1="14%" y1="14%" x2="86%" y2="86%" style="stroke-width:16%" />
			  <line x1="14%" y1="86%" x2="86%" y2="14%" style="stroke-width:16%" />
			</svg>
		</div>
		<div id="dialogResizeTemplate" class="dialogResize">
			<svg class="pageButton button" onmousedown="addResizeListener(evt)">
			  <line x1="10%" y1="90%" x2="90%" y2="10%" style="stroke-width:10%" />
			  <line x1="40%" y1="90%" x2="90%" y2="40%" style="stroke-width:10%" />
			  <line x1="70%" y1="90%" x2="90%" y2="70%" style="stroke-width:10%" />
			</svg>
		</div>		
		<div id="query" style="height: 100%; display: flex; flex-direction: column; align-items: stretch;">
			<div style="flex-grow: 2;"></div>
			<div id="queryCaption" style="text-align: center;"></div>
			<div style="text-align: center; margin-top: 1em"><input type="text" id="querySearch" onkeydown="if (event.keyCode == 13) { querySearch() }" style="width:100%; max-width: 600px; height: 2em;"></div>
			<div id="queryBottom" style="flex-grow: 3;"></div>
		</div>
	</div>

	<div class="is-blocked"></div>
</body>
</html>